(()=>{"use strict";class t{constructor(t,e="",i="local"){this._initialConfig=t,this._storageKey=e,this._persistable=!!e,this._storageType=i,this.load()||(this.data=Object.assign({},this._initialConfig)),this.init()}init(){null==window.appConfig&&(window.appConfig=[]),null==window.appConfigCtrl&&(window.appConfigCtrl=[]),window.appConfig[this._storageKey]=this.data,window.appConfigCtrl[this._storageKey]=this,window.addEventListener("beforeunload",()=>{this.save()})}save(){this._persistable?(("local"===this._storageType?localStorage:sessionStorage).setItem(this._storageKey,JSON.stringify(this.data)),console.log(`Configuration ${this._storageKey} saved to ${this._storageType}`)):console.log(`Configuration ${this._storageKey} not persistable`)}load(){if(!this._persistable)return!1;{const t=("local"===this._storageType?localStorage:sessionStorage).getItem(this._storageKey);if(!t)return console.log(`No Configuration ${this._storageKey} found in ${this._storageType}`),!1;try{return this.data=JSON.parse(t),console.log(`Configuration ${this._storageKey} loaded from ${this._storageType}`),!0}catch(t){return console.error("Error loading configuration ${this._storageKey}:",t),!1}}}clear(){("local"===this._storageType?localStorage:sessionStorage).removeItem(this._storageKey),console.log(`Configuration ${this._storageKey} cleared from ${this._storageType}`)}print(){console.log("Current configuration ${this._storageKey}:",this.data)}reset(){this.data=Object.assign({},this._initialConfig),console.log(`Configuration ${this._storageKey} reset ${JSON.stringify(this.data)}`)}}var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},e(t,i)};function i(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}function r(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,s=i.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){n={error:t}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return o}function s(t,e,i){if(i||2===arguments.length)for(var r,n=0,s=e.length;n<s;n++)!r&&n in e||(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return t.concat(r||Array.prototype.slice.call(e))}function o(t){return"function"==typeof t}function a(t){var e=t(function(t){Error.call(t),t.stack=(new Error).stack});return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var h=a(function(t){return function(e){t(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map(function(t,e){return e+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}});function l(t,e){if(t){var i=t.indexOf(e);0<=i&&t.splice(i,1)}}var c=function(){function t(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}var e;return t.prototype.unsubscribe=function(){var t,e,i,a,l;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var u=r(c),d=u.next();!d.done;d=u.next())d.value.remove(this)}catch(e){t={error:e}}finally{try{d&&!d.done&&(e=u.return)&&e.call(u)}finally{if(t)throw t.error}}else c.remove(this);var p=this.initialTeardown;if(o(p))try{p()}catch(t){l=t instanceof h?t.errors:[t]}var f=this._finalizers;if(f){this._finalizers=null;try{for(var _=r(f),v=_.next();!v.done;v=_.next()){var y=v.value;try{g(y)}catch(t){l=null!=l?l:[],t instanceof h?l=s(s([],n(l)),n(t.errors)):l.push(t)}}}catch(t){i={error:t}}finally{try{v&&!v.done&&(a=_.return)&&a.call(_)}finally{if(i)throw i.error}}}if(l)throw new h(l)}},t.prototype.add=function(e){var i;if(e&&e!==this)if(this.closed)g(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=null!==(i=this._finalizers)&&void 0!==i?i:[]).push(e)}},t.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},t.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},t.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&l(e,t)},t.prototype.remove=function(e){var i=this._finalizers;i&&l(i,e),e instanceof t&&e._removeParent(this)},t.EMPTY=((e=new t).closed=!0,e),t}(),u=c.EMPTY;function d(t){return t instanceof c||t&&"closed"in t&&o(t.remove)&&o(t.add)&&o(t.unsubscribe)}function g(t){o(t)?t():t.unsubscribe()}var p=null,f=null,_=void 0,v=!1,y=!1,m={setTimeout:function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var o=m.delegate;return(null==o?void 0:o.setTimeout)?o.setTimeout.apply(o,s([t,e],n(i))):setTimeout.apply(void 0,s([t,e],n(i)))},clearTimeout:function(t){var e=m.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function b(){}var w=x("C",void 0,void 0);function x(t,e,i){return{kind:t,value:e,error:i}}var S=null;function C(t){if(v){var e=!S;if(e&&(S={errorThrown:!1,error:null}),t(),e){var i=S,r=i.errorThrown,n=i.error;if(S=null,r)throw n}}else t()}var R=function(t){function e(e){var i=t.call(this)||this;return i.isStopped=!1,e?(i.destination=e,d(e)&&e.add(i)):i.destination=T,i}return i(e,t),e.create=function(t,e,i){return new $(t,e,i)},e.prototype.next=function(t){this.isStopped?L(function(t){return x("N",t,void 0)}(t),this):this._next(t)},e.prototype.error=function(t){this.isStopped?L(x("E",void 0,t),this):(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped?L(w,this):(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(c),I=Function.prototype.bind;function M(t,e){return I.call(t,e)}var A=function(){function t(t){this.partialObserver=t}return t.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){E(t)}},t.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){E(t)}else E(t)},t.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){E(t)}},t}(),$=function(t){function e(e,i,r){var n,s,a=t.call(this)||this;return o(e)||!e?n={next:null!=e?e:void 0,error:null!=i?i:void 0,complete:null!=r?r:void 0}:a&&y?((s=Object.create(e)).unsubscribe=function(){return a.unsubscribe()},n={next:e.next&&M(e.next,s),error:e.error&&M(e.error,s),complete:e.complete&&M(e.complete,s)}):n=e,a.destination=new A(n),a}return i(e,t),e}(R);function E(t){var e;v?(e=t,v&&S&&(S.errorThrown=!0,S.error=e)):function(t){m.setTimeout(function(){if(!p)throw t;p(t)})}(t)}function L(t,e){var i=f;i&&m.setTimeout(function(){return i(t,e)})}var T={closed:!0,next:b,error:function(t){throw t},complete:b},D="function"==typeof Symbol&&Symbol.observable||"@@observable";function P(t){return t}var B=function(){function t(t){t&&(this._subscribe=t)}return t.prototype.lift=function(e){var i=new t;return i.source=this,i.operator=e,i},t.prototype.subscribe=function(t,e,i){var r,n=this,s=(r=t)&&r instanceof R||function(t){return t&&o(t.next)&&o(t.error)&&o(t.complete)}(r)&&d(r)?t:new $(t,e,i);return C(function(){var t=n,e=t.operator,i=t.source;s.add(e?e.call(s,i):i?n._subscribe(s):n._trySubscribe(s))}),s},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},t.prototype.forEach=function(t,e){var i=this;return new(e=O(e))(function(e,r){var n=new $({next:function(e){try{t(e)}catch(t){r(t),n.unsubscribe()}},error:r,complete:e});i.subscribe(n)})},t.prototype._subscribe=function(t){var e;return null===(e=this.source)||void 0===e?void 0:e.subscribe(t)},t.prototype[D]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return(0===(i=t).length?P:1===i.length?i[0]:function(t){return i.reduce(function(t,e){return e(t)},t)})(this);var i},t.prototype.toPromise=function(t){var e=this;return new(t=O(t))(function(t,i){var r;e.subscribe(function(t){return r=t},function(t){return i(t)},function(){return t(r)})})},t.create=function(e){return new t(e)},t}();function O(t){var e;return null!==(e=null!=t?t:_)&&void 0!==e?e:Promise}var F=a(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),z=function(t){function e(){var e=t.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return i(e,t),e.prototype.lift=function(t){var e=new N(this,this);return e.operator=t,e},e.prototype._throwIfClosed=function(){if(this.closed)throw new F},e.prototype.next=function(t){var e=this;C(function(){var i,n;if(e._throwIfClosed(),!e.isStopped){e.currentObservers||(e.currentObservers=Array.from(e.observers));try{for(var s=r(e.currentObservers),o=s.next();!o.done;o=s.next())o.value.next(t)}catch(t){i={error:t}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}}})},e.prototype.error=function(t){var e=this;C(function(){if(e._throwIfClosed(),!e.isStopped){e.hasError=e.isStopped=!0,e.thrownError=t;for(var i=e.observers;i.length;)i.shift().error(t)}})},e.prototype.complete=function(){var t=this;C(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var e=t.observers;e.length;)e.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return(null===(t=this.observers)||void 0===t?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(e){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var e=this,i=this,r=i.hasError,n=i.isStopped,s=i.observers;return r||n?u:(this.currentObservers=null,s.push(t),new c(function(){e.currentObservers=null,l(s,t)}))},e.prototype._checkFinalizedStatuses=function(t){var e=this,i=e.hasError,r=e.thrownError,n=e.isStopped;i?t.error(r):n&&t.complete()},e.prototype.asObservable=function(){var t=new B;return t.source=this,t},e.create=function(t,e){return new N(t,e)},e}(B),N=function(t){function e(e,i){var r=t.call(this)||this;return r.destination=e,r.source=i,r}return i(e,t),e.prototype.next=function(t){var e,i;null===(i=null===(e=this.destination)||void 0===e?void 0:e.next)||void 0===i||i.call(e,t)},e.prototype.error=function(t){var e,i;null===(i=null===(e=this.destination)||void 0===e?void 0:e.error)||void 0===i||i.call(e,t)},e.prototype.complete=function(){var t,e;null===(e=null===(t=this.destination)||void 0===t?void 0:t.complete)||void 0===e||e.call(t)},e.prototype._subscribe=function(t){var e,i;return null!==(i=null===(e=this.source)||void 0===e?void 0:e.subscribe(t))&&void 0!==i?i:u},e}(z),k=function(t){function e(e){var i=t.call(this)||this;return i._value=e,i}return i(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(e){var i=t.prototype._subscribe.call(this,e);return!i.closed&&e.next(this._value),i},e.prototype.getValue=function(){var t=this,e=t.hasError,i=t.thrownError,r=t._value;if(e)throw i;return this._throwIfClosed(),r},e.prototype.next=function(e){t.prototype.next.call(this,this._value=e)},e}(z);const V={xMin:0,xMax:1,yCenter:0};class j{constructor(t){this.range$=new k(V),this._resolution=t,this._width=t.width,this._height=t.height,this.setRange(V),console.log(`Grid (${this._width} x ${this._height}) created for resolution: ${t.description}`)}updateRange(t){this.setRange(t),console.log(`Grid (${this._width} x ${this._height}) range set to: ${t.xMin} -> ${t.xMax} and yCenter: ${t.yCenter}`)}getIndex(t,e){return e*this._width+t}pixelToMath(t,e){return[this._xMin+t/this.width*this._xRange,this._yMax-e/this.height*this._yRange]}get resolution(){return this._resolution}get width(){return this._width}get height(){return this._height}get size(){return this._width*this._height}get ratio(){return this._width/this._height}toString(){return`width: ${this.width}, height:${this.height} -> size ${this.size}`}setRange(t){this.range$.next(t),this._yRange=(t.xMax-t.xMin)/this.ratio,this._xMin=t.xMin,this._xMax=t.xMax,this._xRange=t.xMax-t.xMin,this._yMin=t.yCenter-this._yRange/2,this._yMax=t.yCenter+this._yRange/2}}const H=[{width:320,height:320,description:"1:1 - Small preview"},{width:640,height:640,description:"1:1 - Medium preview"},{width:960,height:960,description:"1:1 - Large preview"},{width:1920,height:1920,description:"1:1 - High-res export"},{width:4096,height:4096,description:"1:1 - Ultra HD export"},{width:480,height:320,description:"3:2 - Small preview"},{width:960,height:640,description:"3:2 - Medium preview"},{width:1440,height:960,description:"3:2 - Large preview"},{width:2880,height:1920,description:"3:2 - High-res export"},{width:5760,height:3840,description:"3:2 - Ultra HD export"},{width:320,height:240,description:"4:3 - Small preview"},{width:800,height:600,description:"4:3 - Medium preview"},{width:1024,height:768,description:"4:3 - Large preview"},{width:1920,height:1440,description:"4:3 - High-res export"},{width:4096,height:3072,description:"4:3 - Ultra HD export"},{width:640,height:360,description:"16:9 - Small preview"},{width:854,height:480,description:"16:9 - Medium preview"},{width:1280,height:720,description:"16:9 - Large preview"},{width:1920,height:1080,description:"16:9 - Full HD standard"},{width:3840,height:2160,description:"16:9 - 4K export"},{width:7680,height:4320,description:"16:9 - 8K export"},{width:640,height:400,description:"16:10 - Small preview"},{width:1024,height:640,description:"16:10 - Medium preview"},{width:1280,height:800,description:"16:10 - Large preview"},{width:1920,height:1200,description:"16:10 - High-res export"},{width:3840,height:2400,description:"16:10 - 4K export"},{width:688,height:288,description:"43:18 - Small preview"},{width:1e3,height:420,description:"43:18 - Medium preview"},{width:2560,height:1080,description:"43:18 - Ultrawide desktop"},{width:3840,height:1620,description:"43:18 - High-res ultrawide"},{width:5120,height:2160,description:"43:18 - 5K ultrawide export"}];function K(t){return[t.width,t.height]}function G(t){return`${t.width}x${t.height}`}const U={r:0,g:0,b:0},Y={r:255,g:255,b:255};class W{constructor(t,e=U){if(t.length<2)throw new Error("At least two color segments are required.");if(t.some(t=>t.cycleLength<=0))throw new Error("Each color's cycle length must be a positive number.");this._colorSegments=t,this._totalCycleLength=t.reduce((t,e)=>t+e.cycleLength,0),this._fallBackColor=e}map(t){if(t<0)return this._fallBackColor;const e=Math.round(t)%this._totalCycleLength;let i=0;for(let t=0;t<this._colorSegments.length;t++){const r=this._colorSegments[t],n=this._colorSegments[(t+1)%this._colorSegments.length],s=r.cycleLength;if(e>=i&&e<i+s){const t=(e-i)/s;return{r:Math.round(r.color.r+t*(n.color.r-r.color.r)),g:Math.round(r.color.g+t*(n.color.g-r.color.g)),b:Math.round(r.color.b+t*(n.color.b-r.color.b))}}i+=s}return this._fallBackColor}}class X{constructor(t){this._image$=new k(new Uint8ClampedArray(0)),this.image$=this._image$,this._busy$=new k(!1),this.busy$=this._busy$,this._grid=t}get grid(){return this._grid}updateImage(t){this._image$.next(t)}setIdle(){this._busy$.next(!1)}setBusy(){this._busy$.next(!0)}onDestroy(){this.config.save()}}const q={xMin:-3,xMax:1.8,yCenter:0};class J extends X{constructor(e){super(e),this._maxIterations=255,this.config=new t({gridRange:q},"mandelBrotConfig"),this.name="Mandelbrot Simple",this._colorMapper=new W([{color:U,cycleLength:255},{color:Y,cycleLength:255}]),this.calculate()}updateGridRange(t){console.log("MANDETBROT #updateArea"),null!=t?this.config.data.gridRange=t:this.config.reset(),this.calculate()}setMaxIterations(t){this._maxIterations=t,this.calculate()}calculate(){console.log(`#calculate - with max iterations ${this._maxIterations}`),this.grid.updateRange(this.config.data.gridRange),this.setBusy(),setTimeout(()=>{this._data=new Float64Array(this.grid.size);for(let t=0;t<this.grid.height;t++)for(let e=0;e<this.grid.width;e++)this._data[this.grid.getIndex(e,t)]=this.computeMandelbrot(e,t);this.updateImage(this.createImage()),setTimeout(()=>{this.setIdle()},0)},0)}computeMandelbrot(t,e){const[i,r]=this.grid.pixelToMath(t,e);let n=0,s=0,o=0;for(;n*n+s*s<4&&o<this._maxIterations;){const t=n*n-s*s+i;s=2*n*s+r,n=t,o++}return o}createImage(){const t=new Uint8ClampedArray(4*this.grid.size);for(let e=0;e<this.grid.height;e++)for(let i=0;i<this.grid.width;i++){const r=this.grid.getIndex(i,e);let n=this._data[r];n===this._maxIterations&&(n=-1);const s=this._colorMapper.map(n),o=4*r;t[o]=s.r,t[o+1]=s.g,t[o+2]=s.b,t[o+3]=255}return t}}class Q extends j{static resolutionWithBuffer(t,e){return{width:t.width+2*e,height:t.height+2*e,description:`${t.description} + buffer:${e}`}}constructor(t,e,i){super(Q.resolutionWithBuffer(t,i)),this._buffer=i;const r=this.resolution.width/t.width,n=e.xMax-e.xMin,[s,o]=this.getMathCenter(e);this.updateRange({xMin:s-n/2*r,xMax:s+n/2*r,yCenter:o})}getIndexForCenterArea(t,e){return super.getIndex(t+this._buffer,e+this._buffer)}getMathCenter(t){return[t.xMin+(t.xMax-t.xMin)/2,t.yCenter]}}class Z{constructor(t){this.charges=[{x:-.4,y:-.1,magnitude:.01},{x:.4,y:.2,magnitude:-.01}],this._grid=t,this.precomputeVectors()}getVector(t,e){return[this._vX[this._grid.getIndex(t,e)],this._vY[this._grid.getIndex(t,e)]]}precomputeVectors(){this._vX=new Float64Array(this._grid.size),this._vY=new Float64Array(this._grid.size);for(let t=0;t<this._grid.height;t++)for(let e=0;e<this._grid.width;e++){const[i,r]=this._grid.pixelToMath(e,t),[n,s]=this.computeVector(i,r);this._vX[this._grid.getIndex(e,t)]=n,this._vY[this._grid.getIndex(e,t)]=s}}computeVector(t,e){let i=0,r=0;for(let n=0;n<this.charges.length;n++){const s=t-this.charges[n].x,o=e-this.charges[n].y,a=Math.sqrt(s*s+o*o);i+=this.charges[n].magnitude*s/Math.pow(a,3),r+=this.charges[n].magnitude*o/Math.pow(a,3)}const n=i;i=-r,r=n;const s=Math.sqrt(i*i+r*r);return[i/s,r/s]}}const tt={xMin:-1,xMax:1,yCenter:0};class et extends X{constructor(e){super(e),this._buffer=50,this.config=new t({gridRange:tt},"licConfig"),this.name="LIC",this.calculate()}updateGridRange(t){console.log("LIC #updateArea - not implemented yet"),null!=t?this.config.data.gridRange=t:this.config.reset(),this.calculate()}setMaxIterations(t){}calculate(){this.setBusy();const t=this.config.data.gridRange;this.grid.updateRange(t),this._sourceGrid=new Q(this.grid.resolution,t,this._buffer),this._field=new Z(this._sourceGrid),setTimeout(()=>{this.createSourceData(),this.updateImage(this.createSourceImage()),setTimeout(()=>{this.calculateLIC(),this.updateImage(this.createLicImage()),setTimeout(()=>{this.setIdle()},50)},50)},50)}createSourceData(){this._sourceData=new Float64Array(this._sourceGrid.size);for(let t=0;t<this._sourceGrid.height;t++)for(let e=0;e<this._sourceGrid.width;e++)this._sourceData[this._sourceGrid.getIndex(e,t)]=255*this.biasedRandom(4)}biasedRandom(t=.5){const e=Math.random();return Math.pow(e,1/t)}calculateLIC(){this._licData=new Float64Array(this.grid.size),this.calcLicByLength(10)}createSourceImage(){const t=new Uint8ClampedArray(4*this.grid.size);for(let e=0;e<this.grid.height;e++)for(let i=0;i<this.grid.width;i++){const r=this._sourceGrid.getIndexForCenterArea(i,e);let n=this._sourceData[r];const s=4*this.grid.getIndex(i,e);t[s]=n,t[s+1]=n,t[s+2]=n,t[s+3]=255}return t}createLicImage(){const t=new Uint8ClampedArray(4*this.grid.size);for(let e=0;e<this.grid.height;e++)for(let i=0;i<this.grid.width;i++){const r=this.grid.getIndex(i,e);let n=this._licData[r];const s=4*r;t[s]=n,t[s+1]=n,t[s+2]=n,t[s+3]=255}return t}calcLicByLength(t){t/=Math.SQRT2;let e=0,i=Date.now();console.info("calculation started (type: LENGTH, l: "+2*t+")");for(let i=0;i<this.grid.height;i++){for(let e=0;e<this.grid.width;e++)this._licData[this.grid.getIndex(e,i)]=this.calcLicPixel(i,e,t);e>49&&(console.info("calculating: "+Math.round(100*i/this.grid.height)+"%"),e=0),e++}console.info("calculation done in "+(Date.now()-i)/1e3+"s")}calcLicPixel(t,e,i){let r=this.calcLicPixelInDirection(t,e,i);return r+=this.calcLicPixelInDirection(t,e,i,-1),r=Math.round(r/(2*i)),r>255&&(r=255),r}calcLicPixelInDirection(t,e,i,r=1){let n=i,[s,o]=this._field.getVector(e+this._buffer,t+this._buffer);s*=r,o*=r;let a=this.getNextArea(.5,.5,s,o),h=a.distance<n?a.distance:n,l=this._sourceData[this._sourceGrid.getIndexForCenterArea(e,t)]*h;for(n=i-a.distance;n>0;)t+=a.iDiff,e+=a.jDiff,[s,o]=this._field.getVector(e+this._buffer,t+this._buffer),s*=r,o*=r,a=this.getNextArea(a.x,a.y,s,o),h=a.distance<n?a.distance:n,l+=this._sourceData[this._sourceGrid.getIndexForCenterArea(e,t)]*h,n-=a.distance;return l}getNextArea(t,e,i,r){let n,s=[];s.push((1-e)/r),s.push(-e/r),s.push(-t/i),s.push((1-t)/i),s.forEach((t,e)=>{t<=0&&(s[e]=1/0)});const o=s.indexOf(Math.min(...s)),a=Math.sqrt(Math.pow(s[o]*i,2)+Math.pow(s[o]*r,2))/Math.SQRT2;switch(o){case 0:return n=i*s[o]+t,{iDiff:-1,jDiff:0,x:n,y:.01,distance:a};case 1:return n=i*s[o]+t,{iDiff:1,jDiff:0,x:n,y:.99,distance:a};case 2:return n=r*s[o]+e,{iDiff:0,jDiff:-1,x:.99,y:n,distance:a};case 3:return n=r*s[o]+e,{iDiff:0,jDiff:1,x:.01,y:n,distance:a};default:return{iDiff:0,jDiff:0,x:.5,y:.5,distance:a}}}}const it="invalid-rectangle",rt="user-rectangle",nt="norm-rectangle",st={pixel:"(left, top)",math:"(x, y)"};class ot{constructor(t,e){this.displayableCoordinates$=new k(st),this.selectedRange$=new z,this._p1=null,this._p2=null,this._invalidRect=null,this._validRect=null,this._frozen=!1,this._overlay=t,this._grid=e,this.addSvgCss(),this.addEventListeners()}selectRange(t){this.selectedRange$.next(t)}addSvgCss(){var t=window.document.styleSheets[0];t.insertRule(`#${it} { fill: none; stroke: #ff0000ff; stroke-width: 1; }`,t.cssRules.length),t.insertRule(`#${rt} { fill: none; stroke: #90d5ffff; stroke-width: 1; }`,t.cssRules.length),t.insertRule(`#${nt} { fill: #90d5ff88; stroke: none; }`,t.cssRules.length)}addEventListeners(){this._overlay.addEventListener("mousedown",t=>{this._frozen||this.onMouseDown(t)}),this._overlay.addEventListener("mousemove",t=>{this._frozen||this.onMouseMove(t)}),this._overlay.addEventListener("mouseup",t=>{this._frozen||this.onMouseUp(t)}),this._overlay.addEventListener("mouseleave",()=>{this._frozen||this.onMouseLeave()}),this._overlay.addEventListener("wheel",t=>{this._frozen||this.onMouseWheel(t)})}onMouseDown(t){this._p1={x:t.offsetX,y:t.offsetY}}onMouseMove(t){this._p1?(this._p2={x:t.offsetX,y:t.offsetY},this.evaluateRect(this._p1,this._p2)):this.emitDisplayableCoordinates({x:t.offsetX,y:t.offsetY})}onMouseUp(t){if(null!=this._validRect){const t=this.getMathCoordinatesFromRectangle(this._validRect.norm);this.emitSelection(t)}else if(null!=this._p1&&null==this._p2)return void this.emitFromPosition(t.offsetX,t.offsetY,1);this.resetAllSelections(),this.emitDisplayableCoordinates()}onMouseLeave(){this.resetAllSelections(),this.emitDisplayableCoordinates()}onMouseWheel(t){t.preventDefault(),this.removeInvalidRect(),this.removeValidRect();const e=t.deltaY<0?.25:4;this.emitFromPosition(t.offsetX,t.offsetY,e)}emitFromPosition(t,e,i){this.freeze();const r=this._grid.width*i,n=this._grid.height*i;if(this._p1={x:t-r/2,y:e-n/2},this._p2={x:t+r/2,y:e+n/2},this.createValidRect(this._p1,r,n),null!=this._validRect){const t=this.getMathCoordinatesFromRectangle(this._validRect.norm);setTimeout(()=>{this.unFreeze(),this.resetAllSelections(),this.emitSelection(t)},250)}}freeze(){this._frozen=!0}unFreeze(){this._frozen=!1}resetAllSelections(){this._p1=null,this._p2=null,this.removeInvalidRect(),this.removeValidRect()}removeInvalidRect(){null!=this._invalidRect&&(this._overlay.removeChild(this._invalidRect),this._invalidRect=null)}removeValidRect(){null!=this._validRect&&(this._overlay.removeChild(this._validRect.user),this._overlay.removeChild(this._validRect.norm),this._validRect=null)}evaluateRect(t,e){const i={x:Math.min(t.x,e.x),y:Math.min(t.y,e.y)},r=Math.abs(t.x-e.x),n=Math.abs(t.y-e.y);r<60?(this.removeValidRect(),null==this._invalidRect?this.createInvalidRect(i,r,n):this.updateInvalidRect(this._invalidRect,i,r,n),this.emitDisplayableCoordinates()):(this.removeInvalidRect(),null==this._validRect?this.createValidRect(i,r,n):this.updateValidRect(this._validRect,i,r,n),this.emitDisplayableCoordinates())}createInvalidRect(t,e,i){const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.id=it,r.setAttribute("x",t.x.toString()),r.setAttribute("y",t.y.toString()),r.setAttribute("width",e.toString()),r.setAttribute("height",i.toString()),this._invalidRect=r,this._overlay.appendChild(this._invalidRect)}updateInvalidRect(t,e,i,r){t.setAttribute("x",e.x.toString()),t.setAttribute("y",e.y.toString()),t.setAttribute("width",i.toString()),t.setAttribute("height",r.toString())}createValidRect(t,e,i){const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.id=rt,r.setAttribute("x",t.x.toString()),r.setAttribute("y",t.y.toString()),r.setAttribute("width",e.toString()),r.setAttribute("height",i.toString());const[n,s,o]=this.evaluateNormRect(t,e,i),a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.id=nt,a.setAttribute("x",n.x.toString()),a.setAttribute("y",n.y.toString()),a.setAttribute("width",s.toString()),a.setAttribute("height",o.toString()),this._validRect={user:r,norm:a},this._overlay.appendChild(this._validRect.user),this._overlay.appendChild(this._validRect.norm)}updateValidRect(t,e,i,r){t.user.setAttribute("x",e.x.toString()),t.user.setAttribute("y",e.y.toString()),t.user.setAttribute("width",i.toString()),t.user.setAttribute("height",r.toString());const[n,s,o]=this.evaluateNormRect(e,i,r);t.norm.setAttribute("x",n.x.toString()),t.norm.setAttribute("y",n.y.toString()),t.norm.setAttribute("width",s.toString()),t.norm.setAttribute("height",o.toString())}evaluateNormRect(t,e,i){const r=e/this._grid.ratio;return[{x:t.x,y:t.y+i/2-r/2},e,r]}emitSelection(t){this.selectedRange$.next({xMin:t.x1,xMax:t.x2,yCenter:t.y1+(t.y2-t.y1)/2})}emitDisplayableCoordinates(t=null){null!=this._validRect?this.displayableCoordinates$.next({pixel:this.rectangleCoordinatesToString(this.getPixelCoordinatesFromRectangle(this._validRect.norm)),math:this.rectangleCoordinatesToString(this.getMathCoordinatesFromRectangle(this._validRect.norm),!0)}):null!=this._invalidRect?this.displayableCoordinates$.next({pixel:this.rectangleCoordinatesToString(this.getPixelCoordinatesFromRectangle(this._invalidRect)),math:this.rectangleCoordinatesToString(this.getMathCoordinatesFromRectangle(this._invalidRect),!0)}):null!=t?this.displayableCoordinates$.next({pixel:`(${t.x}, ${t.y})`,math:this.getMathCoordinatesFromPoint(t)}):this.displayableCoordinates$.next(st)}getPixelCoordinatesFromRectangle(t){const e=parseInt(t.getAttribute("x")||"0"),i=parseInt(t.getAttribute("y")||"0");return{x1:e,y1:i,x2:e+parseInt(t.getAttribute("width")||"0"),y2:i+parseInt(t.getAttribute("height")||"0")}}getMathCoordinatesFromRectangle(t){const e=parseInt(t.getAttribute("x")||"0"),i=parseInt(t.getAttribute("y")||"0"),r=parseInt(t.getAttribute("width")||"0"),n=parseInt(t.getAttribute("height")||"0"),[s,o]=this._grid.pixelToMath(e,i),[a,h]=this._grid.pixelToMath(e+r,i+n);return{x1:s,y1:o,x2:a,y2:h}}rectangleCoordinatesToString(t,e=!1){return e?`(${t.x1.toFixed(8)}, ${t.y1.toFixed(8)}) => (${t.x2.toFixed(8)}, ${t.y2.toFixed(8)})`:`(${t.x1}, ${t.y1}) => (${t.x2}, ${t.y2})`}getMathCoordinatesFromPoint(t){const[e,i]=this._grid.pixelToMath(t.x,t.y);return`(${e.toFixed(12)}, ${i.toFixed(12)})`}}class at{constructor(t,e){this._canvas=t,this._grid=e}draw(t){const e=this._canvas.getContext("2d");if(!e)throw new Error("Could not get 2D context");if(0==t.length)return;const i=new ImageData(t,this._grid.width,this._grid.height);e.putImageData(i,0,0)}}class ht{constructor(t,e){this._subscription=null,this._canvas=new at(t,e)}draw(t){this._canvas.draw(t)}setPlane(t){var e;null===(e=this._subscription)||void 0===e||e.unsubscribe(),this._subscription=t.image$.subscribe(t=>{console.log(`#setPlane - plane.image subscription new Image of length ${t.length}`),this._canvas.draw(t)})}}class lt{constructor(){this._widthParameter="width",this._heightParameter="height"}getResolution(){const t=H[17];if(!window.location.hash)return K(t);const e=window.location.hash.substring(1),i=new URLSearchParams(e),r=this.parseIntOrNull(i.get(this._widthParameter)),n=this.parseIntOrNull(i.get(this._heightParameter));return null!==r&&null!==n?[r,n]:K(t)}updateResolution(t,e){const i=`${this._widthParameter}=${encodeURIComponent(t)}&${this._heightParameter}=${encodeURIComponent(e)}`;window.history.replaceState(null,"",`#${i}`)}parseIntOrNull(t){if(!t)return null;const e=Number(t);return isNaN(e)?null:e}}var ct;!function(t){t.MANDELBROT="MANDELBROT",t.LIC="LIC"}(ct||(ct={})),new class{constructor(){this._plane=null,this._urlHandler=new lt,this._headerArea=document.getElementById("header"),this._resolutionSelect=document.getElementById("resolutionSelect"),this._exportButton=document.getElementById("exportButton"),this._mainDiv=document.getElementById("main"),this._htmlCanvas=document.getElementById("canvas"),this._htmlSvg=document.getElementById("svgOverlay"),this._rangeArea=document.getElementById("rangeArea"),this._mathCoordsArea=document.getElementById("mathCoordsArea"),this._pixelCoordsArea=document.getElementById("pixelCoordsArea"),this._rangeInput=document.getElementById("rangeInput"),this._planeSelectArea=document.getElementById("planeSelectArea"),this._planeSelect=document.getElementById("planeSelect"),this._planeConfigArea=document.getElementById("planeConfigArea"),this._busySubscription=null,this._selectionSubscription=null,console.log("#constructor(Start) - YottaPXL - Version: 0.0.1"),function(t){const e="app-version",i=localStorage.getItem(e);i!==t&&(console.info(`#configVersionCheck - storedVersion=${i} does not match appVersion=${t}`),localStorage.clear(),caches.keys().then(t=>{t.forEach(t=>{caches.delete(t)})}),localStorage.setItem(e,t),window.location.reload())}("0.0.1"),this._config=new t({currentPlaneId:0},"mainConfig");const[e,i]=this._urlHandler.getResolution();let r=this.initializeResolution(e,i);r||(console.error("#ctor - initial resolution not found!"),r=H[0]),this._grid=new j(r);let n=this.initializePlaneSelect();window.onload=()=>{this.init(n)}}init(t){null!=this._htmlCanvas&&null!=this._htmlSvg?(this.setHtmlCanvasSize(),this._interactionOverlay=new ot(this._htmlSvg,this._grid),this._stage=new ht(this._htmlCanvas,this._grid),this.switchPlane(t),this.subscribeToCoordinates(),this.subscribeToRange(),this.addResulutionsDropdownEventListener(),this.addPlaneDropdownEventListener(),this.addExportButtonClickListener(),this.addSetRangeButtonClickListener(),this.addIterationsEventListener()):console.error("Critical: HTML elements not found")}switchPlane(t){var e;switch(null===(e=this._plane)||void 0===e||e.onDestroy(),t){case ct.MANDELBROT:this._config.data.currentPlaneId=0,this._plane=new J(this._grid);break;case ct.LIC:this._config.data.currentPlaneId=1,this._plane=new et(this._grid)}this.subscribeToBusyState(),this.subscribeToSelection(),this._stage.setPlane(this._plane)}initializeResolution(t,e){this._resolutionSelect.innerHTML="";let i=null;for(const r of H){const n=document.createElement("option");n.label=`${r.description} - ${r.width}x${r.height}`,n.value=G(r),r.width==t&&r.height==e&&(i=r,n.selected=!0),this._resolutionSelect.appendChild(n)}return i}initializePlaneSelect(){this._planeSelect.innerHTML="";let t=this.getPlaneIdFromConfig();for(const e in ct){const i=document.createElement("option");i.label=`${e}`,i.value=e,e==t&&(i.selected=!0),this._planeSelect.appendChild(i)}return t}getPlaneIdFromConfig(){return 1===this._config.data.currentPlaneId?ct.LIC:ct.MANDELBROT}setHtmlCanvasSize(){const t=this._grid.width,e=this._grid.height;this._htmlCanvas.width=t,this._htmlCanvas.height=e,this._htmlCanvas.setAttribute("width",`${t}px`),this._htmlCanvas.setAttribute("height",`${e}px`),this._htmlSvg.setAttribute("width",`${t}px`),this._htmlSvg.setAttribute("height",`${e}px`),this.setAreaWidth(this._headerArea,t),this.setAreaWidth(this._rangeArea,t),this.setAreaWidth(this._planeSelectArea,t),this.setAreaWidth(this._planeConfigArea,t),this._mainDiv.style.setProperty("visibility","visible")}setAreaWidth(t,e){null!=t&&(t.style.width=`${e+2}px`)}subscribeToCoordinates(){this._interactionOverlay.displayableCoordinates$.subscribe({next:t=>{null!=this._mathCoordsArea&&null!=this._pixelCoordsArea&&(this._mathCoordsArea.textContent=t.math,this._pixelCoordsArea.textContent=t.pixel)}})}subscribeToRange(){this._grid.range$.subscribe({next:t=>{this._rangeInput.value=function(t){return`${t.xMin}/${t.xMax}/${t.yCenter}`}(t)}})}subscribeToSelection(){var t;null===(t=this._selectionSubscription)||void 0===t||t.unsubscribe(),this._selectionSubscription=this._interactionOverlay.selectedRange$.subscribe({next:t=>{var e;null!=t&&(console.log(t),null===(e=this._plane)||void 0===e||e.updateGridRange(t))}})}subscribeToBusyState(){var t;null===(t=this._busySubscription)||void 0===t||t.unsubscribe(),null!=this._plane?this._busySubscription=this._plane.busy$.subscribe({next:t=>{document.getElementById("busyIndicator").className=t?"busyIndicator--busy":"busyIndicator--idle"}}):console.error("#subscribeToBusyState - unexpected _plane is null")}addResulutionsDropdownEventListener(){var t;null===(t=this._resolutionSelect)||void 0===t||t.addEventListener("change",t=>{const e=t.target.value,[i,r]=e.split("x").map(Number);console.log(`Selected resolution: ${i}x${r}`),this._urlHandler.updateResolution(i,r),window.location.reload()})}addPlaneDropdownEventListener(){var t;null===(t=this._planeSelect)||void 0===t||t.addEventListener("change",t=>{const e=t.target.value;switch(console.log(`Selected plane: ${e}`),e){case ct.LIC:this.switchPlane(ct.LIC);break;case ct.MANDELBROT:this.switchPlane(ct.MANDELBROT);break;default:console.warn(`Invalid plane ID: ${e}`)}})}addExportButtonClickListener(){var t;null===(t=this._exportButton)||void 0===t||t.addEventListener("click",t=>{let e=prompt("Enter a filename","image");if(!e)return;e+=".png";const i=this._htmlCanvas.toDataURL("image/png"),r=document.createElement("a");r.download=e,r.href=i,r.click(),setTimeout(()=>{r.remove()},100)})}addSetRangeButtonClickListener(){const t=document.getElementById("setRangeButton");null==t||t.addEventListener("click",t=>{const e=function(t){const e=t.split("/");if(3!=e.length)return console.warn(`#gridRangeFromString - invalid input (parts.length != 3) instead ${e.length}`,t),null;const i=parseFloat(e[0]),r=parseFloat(e[1]),n=parseFloat(e[2]);return i>=r?(console.warn(`#gridRangeFromString - invalid input (xMin >= xMax) instead xMin=${i}, xMax=${r}`,t),null):{xMin:i,xMax:r,yCenter:n}}(this._rangeInput.value);null!==e&&this._interactionOverlay.selectRange(e)});const e=document.getElementById("resetRangeButton");null==e||e.addEventListener("click",t=>{null!=this._plane?this._plane.updateGridRange(null):console.error("#subscribeToBusyState - unexpected _plane is null")})}addIterationsEventListener(){const t=document.getElementById("iterationsInput");t.addEventListener("keypress",e=>{if("Enter"===e.key)if(null!=this._plane){const e=t.valueAsNumber;this._plane.setMaxIterations(e)}else console.error("#subscribeToBusyState - unexpected _plane is null")})}}})();