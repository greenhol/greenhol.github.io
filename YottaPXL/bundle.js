(()=>{"use strict";var t={m:{},u:t=>t+"."+{95:"5c7245807458d2129407",531:"771583be117a422e9375",625:"1573dc8efd4d6a7b9956",793:"8042612b0b771d13be61",883:"509ab25af6f767fc7742",931:"49c94e437803eb484445"}[t]+".js"};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),t.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var i=t.g.document;if(!e&&i&&(i.currentScript&&"SCRIPT"===i.currentScript.tagName.toUpperCase()&&(e=i.currentScript.src),!e)){var r=i.getElementsByTagName("script");if(r.length)for(var n=r.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=r[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})(),t.b="undefined"!=typeof document&&document.baseURI||self.location.href;class e{constructor(t,e="",i="local"){this._initialConfig=t,this._storageKey=e,this._persistable=!!e,this._storageType=i,this.load()||(this.data=Object.assign({},this._initialConfig)),this.init()}init(){null==window.appConfig&&(window.appConfig=[]),null==window.appConfigCtrl&&(window.appConfigCtrl=[]),window.appConfig[this._storageKey]=this.data,window.appConfigCtrl[this._storageKey]=this,window.addEventListener("beforeunload",()=>{this.save()})}save(){this._persistable?(("local"===this._storageType?localStorage:sessionStorage).setItem(this._storageKey,JSON.stringify(this.data)),console.log(`Configuration ${this._storageKey} saved to ${this._storageType}`)):console.log(`Configuration ${this._storageKey} not persistable`)}load(){if(!this._persistable)return!1;{const t=("local"===this._storageType?localStorage:sessionStorage).getItem(this._storageKey);if(!t)return console.log(`No Configuration ${this._storageKey} found in ${this._storageType}`),!1;try{return this.data=JSON.parse(t),console.log(`Configuration ${this._storageKey} loaded from ${this._storageType}`),!0}catch(t){return console.error("Error loading configuration ${this._storageKey}:",t),!1}}}clear(){("local"===this._storageType?localStorage:sessionStorage).removeItem(this._storageKey),console.log(`Configuration ${this._storageKey} cleared from ${this._storageType}`)}print(){console.log("Current configuration ${this._storageKey}:",this.data)}reset(){this.data=Object.assign({},this._initialConfig),console.log(`Configuration ${this._storageKey} reset ${JSON.stringify(this.data)}`)}}function i(t){return t.xMax-t.xMin}function r(t){return`${t.xMin}_${t.xMax}_${t.yCenter}`}var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},n(t,e)};function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function o(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,s=i.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){n={error:t}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return o}function h(t,e,i){if(i||2===arguments.length)for(var r,n=0,s=e.length;n<s;n++)!r&&n in e||(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return t.concat(r||Array.prototype.slice.call(e))}function c(t){return"function"==typeof t}function l(t){var e=t(function(t){Error.call(t),t.stack=(new Error).stack});return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var d=l(function(t){return function(e){t(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map(function(t,e){return e+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}});function u(t,e){if(t){var i=t.indexOf(e);0<=i&&t.splice(i,1)}}var g=function(){function t(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}var e;return t.prototype.unsubscribe=function(){var t,e,i,r,n;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var l=o(s),u=l.next();!u.done;u=l.next())u.value.remove(this)}catch(e){t={error:e}}finally{try{u&&!u.done&&(e=l.return)&&e.call(l)}finally{if(t)throw t.error}}else s.remove(this);var g=this.initialTeardown;if(c(g))try{g()}catch(t){n=t instanceof d?t.errors:[t]}var p=this._finalizers;if(p){this._finalizers=null;try{for(var f=o(p),v=f.next();!v.done;v=f.next()){var y=v.value;try{_(y)}catch(t){n=null!=n?n:[],t instanceof d?n=h(h([],a(n)),a(t.errors)):n.push(t)}}}catch(t){i={error:t}}finally{try{v&&!v.done&&(r=f.return)&&r.call(f)}finally{if(i)throw i.error}}}if(n)throw new d(n)}},t.prototype.add=function(e){var i;if(e&&e!==this)if(this.closed)_(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=null!==(i=this._finalizers)&&void 0!==i?i:[]).push(e)}},t.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},t.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},t.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&u(e,t)},t.prototype.remove=function(e){var i=this._finalizers;i&&u(i,e),e instanceof t&&e._removeParent(this)},t.EMPTY=((e=new t).closed=!0,e),t}(),p=g.EMPTY;function f(t){return t instanceof g||t&&"closed"in t&&c(t.remove)&&c(t.add)&&c(t.unsubscribe)}function _(t){c(t)?t():t.unsubscribe()}var v=null,y=null,m=void 0,w=!1,x=!1,b={setTimeout:function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var n=b.delegate;return(null==n?void 0:n.setTimeout)?n.setTimeout.apply(n,h([t,e],a(i))):setTimeout.apply(void 0,h([t,e],a(i)))},clearTimeout:function(t){var e=b.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function I(){}var R=S("C",void 0,void 0);function S(t,e,i){return{kind:t,value:e,error:i}}var M=null;function C(t){if(w){var e=!M;if(e&&(M={errorThrown:!1,error:null}),t(),e){var i=M,r=i.errorThrown,n=i.error;if(M=null,r)throw n}}else t()}var T=function(t){function e(e){var i=t.call(this)||this;return i.isStopped=!1,e?(i.destination=e,f(e)&&e.add(i)):i.destination=L,i}return s(e,t),e.create=function(t,e,i){return new N(t,e,i)},e.prototype.next=function(t){this.isStopped?O(function(t){return S("N",t,void 0)}(t),this):this._next(t)},e.prototype.error=function(t){this.isStopped?O(S("E",void 0,t),this):(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped?O(R,this):(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(g),B=Function.prototype.bind;function A(t,e){return B.call(t,e)}var E=function(){function t(t){this.partialObserver=t}return t.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){D(t)}},t.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){D(t)}else D(t)},t.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){D(t)}},t}(),N=function(t){function e(e,i,r){var n,s,o=t.call(this)||this;return c(e)||!e?n={next:null!=e?e:void 0,error:null!=i?i:void 0,complete:null!=r?r:void 0}:o&&x?((s=Object.create(e)).unsubscribe=function(){return o.unsubscribe()},n={next:e.next&&A(e.next,s),error:e.error&&A(e.error,s),complete:e.complete&&A(e.complete,s)}):n=e,o.destination=new E(n),o}return s(e,t),e}(T);function D(t){var e;w?(e=t,w&&M&&(M.errorThrown=!0,M.error=e)):function(t){b.setTimeout(function(){if(!v)throw t;v(t)})}(t)}function O(t,e){var i=y;i&&b.setTimeout(function(){return i(t,e)})}var L={closed:!0,next:I,error:function(t){throw t},complete:I},P="function"==typeof Symbol&&Symbol.observable||"@@observable";function $(t){return t}var U=function(){function t(t){t&&(this._subscribe=t)}return t.prototype.lift=function(e){var i=new t;return i.source=this,i.operator=e,i},t.prototype.subscribe=function(t,e,i){var r,n=this,s=(r=t)&&r instanceof T||function(t){return t&&c(t.next)&&c(t.error)&&c(t.complete)}(r)&&f(r)?t:new N(t,e,i);return C(function(){var t=n,e=t.operator,i=t.source;s.add(e?e.call(s,i):i?n._subscribe(s):n._trySubscribe(s))}),s},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},t.prototype.forEach=function(t,e){var i=this;return new(e=F(e))(function(e,r){var n=new N({next:function(e){try{t(e)}catch(t){r(t),n.unsubscribe()}},error:r,complete:e});i.subscribe(n)})},t.prototype._subscribe=function(t){var e;return null===(e=this.source)||void 0===e?void 0:e.subscribe(t)},t.prototype[P]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return(0===(i=t).length?$:1===i.length?i[0]:function(t){return i.reduce(function(t,e){return e(t)},t)})(this);var i},t.prototype.toPromise=function(t){var e=this;return new(t=F(t))(function(t,i){var r;e.subscribe(function(t){return r=t},function(t){return i(t)},function(){return t(r)})})},t.create=function(e){return new t(e)},t}();function F(t){var e;return null!==(e=null!=t?t:m)&&void 0!==e?e:Promise}var k=l(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),z=function(t){function e(){var e=t.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return s(e,t),e.prototype.lift=function(t){var e=new V(this,this);return e.operator=t,e},e.prototype._throwIfClosed=function(){if(this.closed)throw new k},e.prototype.next=function(t){var e=this;C(function(){var i,r;if(e._throwIfClosed(),!e.isStopped){e.currentObservers||(e.currentObservers=Array.from(e.observers));try{for(var n=o(e.currentObservers),s=n.next();!s.done;s=n.next())s.value.next(t)}catch(t){i={error:t}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}}})},e.prototype.error=function(t){var e=this;C(function(){if(e._throwIfClosed(),!e.isStopped){e.hasError=e.isStopped=!0,e.thrownError=t;for(var i=e.observers;i.length;)i.shift().error(t)}})},e.prototype.complete=function(){var t=this;C(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var e=t.observers;e.length;)e.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return(null===(t=this.observers)||void 0===t?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(e){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var e=this,i=this,r=i.hasError,n=i.isStopped,s=i.observers;return r||n?p:(this.currentObservers=null,s.push(t),new g(function(){e.currentObservers=null,u(s,t)}))},e.prototype._checkFinalizedStatuses=function(t){var e=this,i=e.hasError,r=e.thrownError,n=e.isStopped;i?t.error(r):n&&t.complete()},e.prototype.asObservable=function(){var t=new U;return t.source=this,t},e.create=function(t,e){return new V(t,e)},e}(U),V=function(t){function e(e,i){var r=t.call(this)||this;return r.destination=e,r.source=i,r}return s(e,t),e.prototype.next=function(t){var e,i;null===(i=null===(e=this.destination)||void 0===e?void 0:e.next)||void 0===i||i.call(e,t)},e.prototype.error=function(t){var e,i;null===(i=null===(e=this.destination)||void 0===e?void 0:e.error)||void 0===i||i.call(e,t)},e.prototype.complete=function(){var t,e;null===(e=null===(t=this.destination)||void 0===t?void 0:t.complete)||void 0===e||e.call(t)},e.prototype._subscribe=function(t){var e,i;return null!==(i=null===(e=this.source)||void 0===e?void 0:e.subscribe(t))&&void 0!==i?i:p},e}(z),W=function(t){function e(e){var i=t.call(this)||this;return i._value=e,i}return s(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(e){var i=t.prototype._subscribe.call(this,e);return!i.closed&&e.next(this._value),i},e.prototype.getValue=function(){var t=this,e=t.hasError,i=t.thrownError,r=t._value;if(e)throw i;return this._throwIfClosed(),r},e.prototype.next=function(e){t.prototype.next.call(this,this._value=e)},e}(z);class G{static copy(t){return new G(t.resolution,t.range)}constructor(t,e){this._resolution=t,this._width=t.width,this._height=t.height,this.setRange(e),console.log(`Grid (${this._width} x ${this._height}) created for resolution: ${t.description}`)}updateRange(t){this.setRange(t),console.log(`Grid (${this._width} x ${this._height}) range set to: ${t.xMin} -> ${t.xMax} and yCenter: ${t.yCenter}`)}getIndex(t,e){return e*this._width+t}pixelToMath(t,e){return[this._xMin+t/this.width*this._xDiff,this._yMax-e/this.height*this._yDiff]}mathToPixel(t,e){return[Math.round((t-this._xMin)*this.width/this._xDiff),Math.round((this._yMax-e)*this.height/this._yDiff)]}get resolution(){return this._resolution}get width(){return this._width}get height(){return this._height}get size(){return this._width*this._height}get ratio(){return this._width/this._height}get range(){return this._range}get xDiff(){return this._xDiff}get blueprint(){return{resolution:{width:this._width,height:this.height,description:`${this._resolution.description} (Copy)`},range:this._range}}toString(){return`width: ${this.width}, height:${this.height} -> size ${this.size}`}setRange(t){this._range=t,this._yDiff=i(t)/this.ratio,this._xMin=t.xMin,this._xMax=t.xMax,this._xDiff=i(t),this._yMin=t.yCenter-this._yDiff/2,this._yMax=t.yCenter+this._yDiff/2}}const Y={xMin:0,xMax:1,yCenter:0};class H extends G{constructor(t,e=Y){super(t,e),this._range$=new W(Y),this.range$=this._range$}updateRange(t){super.updateRange(t),this._range$.next(t)}}const K=[{width:320,height:320,description:"1:1 - Small preview"},{width:640,height:640,description:"1:1 - Medium preview"},{width:960,height:960,description:"1:1 - Large preview"},{width:1920,height:1920,description:"1:1 - High-res export"},{width:4096,height:4096,description:"1:1 - Ultra HD export"},{width:480,height:320,description:"3:2 - Small preview"},{width:960,height:640,description:"3:2 - Medium preview"},{width:1440,height:960,description:"3:2 - Large preview"},{width:2880,height:1920,description:"3:2 - High-res export"},{width:5760,height:3840,description:"3:2 - Ultra HD export"},{width:320,height:240,description:"4:3 - Small preview"},{width:800,height:600,description:"4:3 - Medium preview"},{width:1024,height:768,description:"4:3 - Large preview"},{width:1920,height:1440,description:"4:3 - High-res export"},{width:4096,height:3072,description:"4:3 - Ultra HD export"},{width:640,height:360,description:"16:9 - Small preview"},{width:854,height:480,description:"16:9 - Medium preview"},{width:1280,height:720,description:"16:9 - Large preview"},{width:1920,height:1080,description:"16:9 - Full HD standard"},{width:2560,height:1440,description:"16:9 - QHD desktop"},{width:3840,height:2160,description:"16:9 - 4K export"},{width:7680,height:4320,description:"16:9 - 8K export"},{width:640,height:400,description:"16:10 - Small preview"},{width:1024,height:640,description:"16:10 - Medium preview"},{width:1280,height:800,description:"16:10 - Large preview"},{width:1920,height:1200,description:"16:10 - High-res export"},{width:2560,height:1600,description:"16:9 - WQXGA desktop"},{width:3840,height:2400,description:"16:10 - 4K export"},{width:688,height:288,description:"43:18 - Small preview"},{width:1e3,height:420,description:"43:18 - Medium preview"},{width:2560,height:1080,description:"43:18 - Ultrawide desktop"},{width:3440,height:1440,description:"43:18 - UWQHD desktop"},{width:3840,height:1620,description:"43:18 - High-res ultrawide"},{width:5120,height:2160,description:"43:18 - 5K ultrawide export"}],j=K[15];function q(t){return[t.width,t.height]}function Q(t){return`${t.width}x${t.height}`}var X,J,Z,tt=l(function(t){return function(){t(this),this.name="EmptyError",this.message="no elements in sequence"}});function et(t,e){var i="object"==typeof e;return new Promise(function(r,n){var s,o=!1;t.subscribe({next:function(t){s=t,o=!0},error:n,complete:function(){o?r(s):i?r(e.defaultValue):n(new tt)}})})}function it(t,e,i=[]){const r=new W({progress:0});return t.postMessage({type:J.START,data:e},i),t.onmessage=e=>{switch(e.data.type){case Z.UPDATE:r.next({progress:e.data.progress});break;case Z.RESULT:r.next({progress:100,data:e.data.result}),r.complete(),t.terminate();break;default:console.warn(`#executeWorker - unhandled message type: ${e.data.type}`)}},r}!function(t){t[t.ITERATIONS=0]="ITERATIONS",t[t.DISTANCE=1]="DISTANCE"}(X||(X={})),function(t){t.START="START"}(J||(J={})),function(t){t.UPDATE="UPDATE",t.RESULT="RESULT"}(Z||(Z={}));class rt{calculateIterationsSync(t,e){let i=Date.now();const r=new Float64Array(t.size);for(let i=0;i<t.height;i++)for(let n=0;n<t.width;n++)r[t.getIndex(n,i)]=this.calculateIterationsForPixel(n,i,t,e,4);return console.info("#calculateIterations - calculation done in "+(Date.now()-i)/1e3+"s"),r}calculateDistancesSync(t,e,i){let r=Date.now();const n=new Float64Array(t.size);for(let r=0;r<t.height;r++)for(let s=0;s<t.width;s++)n[t.getIndex(s,r)]=this.calculateDistanceForPixel(s,r,t,e,i);return console.info("#calculateDistances - calculation done in "+(Date.now()-r)/1e3+"s"),n}calculateIterations(t,e){return this.calculateWithWorker(X.ITERATIONS,t,e,4)}calculateDistances(t,e,i){return this.calculateWithWorker(X.DISTANCE,t,e,i)}calculateWithWorker(e,i,r,n){return it(new Worker(new URL(t.p+t.u(931),t.b)),{gridBlueprint:i.blueprint,type:e,maxIterations:r,escapeValue:n})}calculateIterationsForPixel(t,e,i,r,n){const[s,o]=i.pixelToMath(t,e);let a=0,h=0,c=0;for(;a*a+h*h<n&&c<r;){const t=a*a-h*h+s;h=2*a*h+o,a=t,c++}return c}calculateDistanceForPixel(t,e,i,r,n){const[s,o]=i.pixelToMath(t,e);let a=0,h=0,c=0,l=0,d=0;for(;d<r;){const t=2*a*h;a=a*a-h*h+s,h=t+o;const e=2*(a*l+h*c);c=2*(a*c-h*l)+1,l=e;const i=Math.sqrt(a*a+h*h);if(i>n){const t=Math.sqrt(c*c+l*l);return i*Math.log(i)*2/t}d++}return 0}}const nt={r:0,g:0,b:0},st={r:255,g:255,b:255};function ot(t){const e=Math.round(255*t);return{r:e,g:e,b:e}}class at{constructor(t,e=nt){if(t.length<2)throw new Error("At least two color segments are required.");if(t.some(t=>t.cycleLength<=0))throw new Error("Each color's cycle length must be a positive number.");this._colorSegments=t,this._totalCycleLength=t.reduce((t,e)=>t+e.cycleLength,0),this._fallBackColor=e}map(t){if(t<0)return this._fallBackColor;const e=t%this._totalCycleLength;let i=0;for(let t=0;t<this._colorSegments.length;t++){const r=this._colorSegments[t],n=this._colorSegments[(t+1)%this._colorSegments.length],s=r.cycleLength;if(e>=i&&e<i+s){const t=(e-i)/s,o=Math.round(r.color.r+t*(n.color.r-r.color.r)),a=Math.round(r.color.g+t*(n.color.g-r.color.g)),h=Math.round(r.color.b+t*(n.color.b-r.color.b));return{r:Math.round(o),g:Math.round(a),b:Math.round(h)}}i+=s}return this._fallBackColor}}class ht{constructor(t){this._image$=new W(new Uint8ClampedArray(0)),this.image$=this._image$,this._busy$=new W(null),this.busy$=this._busy$,this._grid=t}updateGridRange(t){null!=t?this.config.data.gridRange=t:this.config.reset(),this.grid.updateRange(this.config.data.gridRange),this.refresh()}get grid(){return this._grid}updateImage(t){this._image$.next(t)}setIdle(){this._busy$.next(null)}setProgress(t){this._busy$.next(t)}onDestroy(){this.config.save()}}function ct(t,e,i){if(0!==t)return Math.min(Math.max(t,1),1e5);let r=255+100*Math.log(e/i);return Math.ceil(Math.min(Math.max(r,255),1e4))}const lt={xMin:-3,xMax:1.8,yCenter:0};class dt extends ht{constructor(t){super(t),this._effectiveMaxIterations=255,this.config=new e({gridRange:lt,maxIterations:0,escapeValue:100},"mandelbrotDistanceConfig"),this.grid.updateRange(this.config.data.gridRange),this.calculate()}refresh(){this.calculate()}calculate(){return t=this,e=void 0,n=function*(){const t=new rt;this._effectiveMaxIterations=ct(this.config.data.maxIterations,i(lt),this.grid.xDiff),console.log(`#calculate - with max iterations ${this._effectiveMaxIterations}`),this.setProgress(0);const e=t.calculateDistances(this.grid,this._effectiveMaxIterations,this.config.data.escapeValue);e.subscribe({next:t=>{this.setProgress(t.progress)}});const r=yield et(e);null!=r.data?(this.updateImage(this.createImage(r.data)),this.setIdle()):console.error("#calculate - calculation did not produce data")},new((r=void 0)||(r=Promise))(function(i,s){function o(t){try{h(n.next(t))}catch(t){s(t)}}function a(t){try{h(n.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(o,a)}h((n=n.apply(t,e||[])).next())});var t,e,r,n}createImage(t){const e=new Uint8ClampedArray(4*this.grid.size),i=this.grid.xDiff/this.config.data.escapeValue/50,r=new at([{color:nt,cycleLength:i},{color:st,cycleLength:i}],st);for(let i=0;i<this.grid.height;i++)for(let n=0;n<this.grid.width;n++){const s=this.grid.getIndex(n,i);let o=t[s];o<=0&&(o=-1);const a=r.map(o),h=4*s;e[h]=a.r,e[h+1]=a.g,e[h+2]=a.b,e[h+3]=255}return e}}const ut={xMin:-3,xMax:1.8,yCenter:0};class gt extends ht{constructor(t){super(t),this._effectiveMaxIterations=255,this.config=new e({gridRange:ut,maxIterations:0,escapeValue:2},"mandelbrotIterationsConfig"),this.grid.updateRange(this.config.data.gridRange),this.calculate()}refresh(){this.calculate()}calculate(){return t=this,e=void 0,n=function*(){this._effectiveMaxIterations=ct(this.config.data.maxIterations,i(ut),this.grid.xDiff),console.log(`#calculate - with max iterations ${this._effectiveMaxIterations}`),this.setProgress(0);const t=(new rt).calculateIterations(this.grid,this._effectiveMaxIterations);t.subscribe({next:t=>{this.setProgress(t.progress)}});const e=yield et(t);null!=e.data?(this.updateImage(this.createImage(e.data)),this.setIdle()):console.error("#calculate - calculation did not produce data")},new((r=void 0)||(r=Promise))(function(i,s){function o(t){try{h(n.next(t))}catch(t){s(t)}}function a(t){try{h(n.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(o,a)}h((n=n.apply(t,e||[])).next())});var t,e,r,n}createImage(t){const e=new Uint8ClampedArray(4*this.grid.size),i=new at([{color:nt,cycleLength:255},{color:st,cycleLength:255}]);for(let r=0;r<this.grid.height;r++)for(let n=0;n<this.grid.width;n++){const s=this.grid.getIndex(n,r);let o=t[s];o===this._effectiveMaxIterations&&(o=-1);const a=i.map(o),h=4*s;e[h]=a.r,e[h+1]=a.g,e[h+2]=a.b,e[h+3]=255}return e}}class pt extends G{static resolutionWithMargin(t,e){return{width:t.width+2*e,height:t.height+2*e,description:`${t.description} + buffer:${e}`}}static copyWithMargin(t){return new pt(t.baseResolution,t.baseRange,t.margin)}constructor(t,e,r){const n=pt.resolutionWithMargin(t,r).width/t.width,s=i(e),o=e.xMin+i(e)/2;super(pt.resolutionWithMargin(t,r),{xMin:o-s/2*n,xMax:o+s/2*n,yCenter:e.yCenter}),this._baseResolution=t,this._baseRange=e,this._margin=r}getIndexForCenterArea(t,e){return super.getIndex(t+this._margin,e+this._margin)}get margin(){return this._margin}get withMarginBlueprint(){return{baseResolution:{width:this._baseResolution.width,height:this._baseResolution.height,description:`${this._baseResolution.description} (Copy)`},baseRange:this._baseRange,margin:this._margin}}}class ft{constructor(t,e){this._image=t.image,this._fieldData=t.field,this._sourceGrid=t.grid,this._targetGrid=e}calculate(e,i=0,r=-1){const n=new Worker(new URL(t.p+t.u(625),t.b)),s={sourceGridBlueprint:this._sourceGrid.withMarginBlueprint,image:this._image,field:this._fieldData,targetGridBlueprint:this._targetGrid.blueprint,maxLength:e,minLength:i,strength:r};return it(n,s,[s.image.buffer,s.field.buffer])}}var _t,vt;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ISOLATED=1]="ISOLATED",t[t.ISOLATED_BIG=2]="ISOLATED_BIG"}(_t||(_t={})),function(t){t[t.LOWER=0]="LOWER",t[t.UPPER=1]="UPPER",t[t.CENTER=2]="CENTER",t[t.BOUNDS=3]="BOUNDS",t[t.BOUNDS_BY_CUBIC=4]="BOUNDS_BY_CUBIC",t[t.BOUNDS_BY_QUINTIC=5]="BOUNDS_BY_QUINTIC",t[t.BOUNDS_BY_SEPTIC=6]="BOUNDS_BY_SEPTIC",t[t.BOUNDS_BY_TRIG=7]="BOUNDS_BY_TRIG"}(vt||(vt={}));class yt{constructor(t){this._grid=t}testBiasedDistributions(){this.printRandomDistribution("randomBiasedToLower",this.randomBiasedToLower),this.printRandomDistribution("randomBiasedToUpper",this.randomBiasedToUpper),this.printRandomDistribution("randomBiasedToCenter",this.randomBiasedToCenter),this.printRandomDistribution("randomBiasedToBounds",this.randomBiasedToBounds),this.printRandomDistribution("randomBiasedToBoundsByCubic",this.randomBiasedToBoundsByCubic),this.printRandomDistribution("randomBiasedToBoundsByQuintic",this.randomBiasedToBoundsByQuintic),this.printRandomDistribution("randomBiasedToBoundsBySeptic",this.randomBiasedToBoundsBySeptic),this.printRandomDistribution("randomBiasedToBoundsByTrig",this.randomBiasedToBoundsByTrig)}createWhiteNoiseSync(){const t=new Float64Array(this._grid.size);for(let e=0;e<this._grid.height;e++)for(let i=0;i<this._grid.width;i++)t[this._grid.getIndex(i,e)]=Math.random();return t}createWhiteNoise(){return it(new Worker(new URL(t.p+t.u(883),t.b)),{gridBlueprint:this._grid.withMarginBlueprint})}createBernoulliNoiseSync(t=.5){const e=new Float64Array(this._grid.size);for(let i=0;i<this._grid.height;i++)for(let r=0;r<this._grid.width;r++)e[this._grid.getIndex(r,i)]=Math.random()<t?0:1;return e}createIsolatedBlackNoiseSync(t=.5){const e=this.createBernoulliNoiseSync(t);for(let t=0;t<this._grid.height;t++)for(let i=0;i<this._grid.width;i++)if(0==e[this._grid.getIndex(i,t)]){if(i>0&&0==e[this._grid.getIndex(i-1,t)]){e[this._grid.getIndex(i,t)]=1;continue}const r=t-1;for(let n=-1;n<=1;n++){const s=i+n;r>=0&&s>=0&&s<this._grid.width&&0==e[this._grid.getIndex(s,r)]&&(e[this._grid.getIndex(i,t)]=1)}}return e}createIsolatedBigBlackNoiseSync(t=.5){const e=this.createBernoulliNoiseSync(t);for(let t=0;t<this._grid.height;t++)for(let i=0;i<this._grid.width;i++)if(0==e[this._grid.getIndex(i,t)]){if(i>0&&0==e[this._grid.getIndex(i-1,t)]){e[this._grid.getIndex(i,t)]=1;continue}if(i>1&&0==e[this._grid.getIndex(i-2,t)]){e[this._grid.getIndex(i,t)]=1;continue}let r=t-2;for(let n=-2;n<=2;n++){const s=i+n;r>=0&&s>=0&&s<this._grid.width&&0==e[this._grid.getIndex(s,r)]&&(e[this._grid.getIndex(i,t)]=1)}r=t-1;for(let n=-2;n<=2;n++){const s=i+n;r>=0&&s>=0&&s<this._grid.width&&0==e[this._grid.getIndex(s,r)]&&(e[this._grid.getIndex(i,t)]=1)}}for(let t=0;t<this._grid.height;t++)for(let i=0;i<this._grid.width;i++)0==e[this._grid.getIndex(i,t)]&&(t>0&&i>0&&(e[this._grid.getIndex(i-1,t-1)]=0),i>0&&(e[this._grid.getIndex(i-1,t)]=0),t>0&&(e[this._grid.getIndex(i,t-1)]=0));return e}createBernoulliNoise(t=.5){return this.createBernoulliNoiseOfType(_t.DEFAULT,t)}createBernoulliNoiseIsolated(t=.5){return this.createBernoulliNoiseOfType(_t.ISOLATED,t)}createBernoulliNoiseIsolatedBig(t=.5){return this.createBernoulliNoiseOfType(_t.ISOLATED_BIG,t)}createBernoulliNoiseOfType(e,i=.5){return it(new Worker(new URL(t.p+t.u(531),t.b)),{type:e,gridBlueprint:this._grid.withMarginBlueprint,p:i})}createBiasedNoiseSync(t){const e=new Float64Array(this._grid.size);let i;switch(t){case vt.LOWER:i=this.randomBiasedToLower;break;case vt.UPPER:i=this.randomBiasedToUpper;break;case vt.CENTER:i=this.randomBiasedToCenter;break;case vt.BOUNDS:i=this.randomBiasedToBounds;break;case vt.BOUNDS_BY_CUBIC:i=this.randomBiasedToBoundsByCubic;break;case vt.BOUNDS_BY_QUINTIC:i=this.randomBiasedToBoundsByQuintic;break;case vt.BOUNDS_BY_SEPTIC:i=this.randomBiasedToBoundsBySeptic;break;case vt.BOUNDS_BY_TRIG:i=this.randomBiasedToBoundsByTrig}for(let t=0;t<this._grid.height;t++)for(let r=0;r<this._grid.width;r++)e[this._grid.getIndex(r,t)]=i();return e}createBiasedNoise(e){return it(new Worker(new URL(t.p+t.u(793),t.b)),{type:e,gridBlueprint:this._grid.withMarginBlueprint})}createGaussianNoiseSync(t=0,e=1,i=6){const r=t-i/2*e,n=t+i/2*e,s=new Float64Array(this._grid.size);for(let o=0;o<this._grid.height;o++)for(let a=0;a<this._grid.width;a++){let[h,c]=this.boxMullerTransform();h=h*e+t,h=Math.max(r,Math.min(n,h)),c=c*e+t,c=Math.max(r,Math.min(n,c)),s[this._grid.getIndex(a,o)]=(h-r)/i,a++,s[this._grid.getIndex(a,o)]=(c-r)/i}return s}createGaussianNoise(e=0,i=1,r=6){return it(new Worker(new URL(t.p+t.u(95),t.b)),{gridBlueprint:this._grid.withMarginBlueprint,mean:e,standardDeviation:i,range:r})}randomBiasedToLower(){return 1-Math.sqrt(1-Math.pow(Math.random(),2))}randomBiasedToUpper(){return Math.sqrt(1-Math.pow(Math.random()-1,2))}randomBiasedToCenter(){const t=Math.random();return t<=.5?Math.sqrt(1-Math.pow(2*t-1,2))/2:1-Math.sqrt(1-Math.pow(2*t-1,2))/2}randomBiasedToBounds(){const t=Math.random();return t<=.5?.5-Math.sqrt(1-Math.pow(2*t,2))/2:.5+Math.sqrt(1-Math.pow(2*t-2,2))/2}randomBiasedToBoundsByCubic(){const t=Math.random();return-2*Math.pow(t,3)+3*Math.pow(t,2)}randomBiasedToBoundsByQuintic(){const t=Math.random();return 6*Math.pow(t,5)-15*Math.pow(t,4)+10*Math.pow(t,3)}randomBiasedToBoundsBySeptic(){const t=Math.random();return-20*Math.pow(t,7)+70*Math.pow(t,6)-84*Math.pow(t,5)+35*Math.pow(t,4)}randomBiasedToBoundsByTrig(){return(1-Math.cos(Math.random()*Math.PI))/2}boxMullerTransform(){let t=0,e=0;for(;0===t;)t=Math.random();for(;0===e;)e=Math.random();return[Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*e),Math.sqrt(-2*Math.log(t))*Math.sin(2*Math.PI*e)]}printRandomDistribution(t,e){const i={"0.0-0.1":0,"0.1-0.2":0,"0.2-0.3":0,"0.3-0.4":0,"0.4-0.5":0,"0.5-0.6":0,"0.6-0.7":0,"0.7-0.8":0,"0.8-0.9":0,"0.9-1.0":0};for(let t=0;t<5e3;t++){const t=e();t<.1?i["0.0-0.1"]++:t<.2?i["0.1-0.2"]++:t<.3?i["0.2-0.3"]++:t<.4?i["0.3-0.4"]++:t<.5?i["0.4-0.5"]++:t<.6?i["0.5-0.6"]++:t<.7?i["0.6-0.7"]++:t<.8?i["0.7-0.8"]++:t<.9?i["0.8-0.9"]++:i["0.9-1.0"]++}console.log(t,i)}}const mt={order:6,x:[[-1,-3,-4,-6,-7,-8,0,8,7,6,4,3,1],[-3,-5,-7,-9,-10,-11,0,11,10,9,7,5,3],[-4,-7,-9,-11,-13,-14,0,14,13,11,9,7,4],[-6,-9,-11,-14,-16,-17,0,17,16,14,11,9,6],[-7,-10,-13,-16,-18,-19,0,19,18,16,13,10,7],[-8,-11,-14,-17,-19,-20,0,20,19,17,14,11,8],[-9,-12,-15,-18,-20,-21,0,21,20,18,15,12,9],[-8,-11,-14,-17,-19,-20,0,20,19,17,14,11,8],[-7,-10,-13,-16,-18,-19,0,19,18,16,13,10,7],[-6,-9,-11,-14,-16,-17,0,17,16,14,11,9,6],[-4,-7,-9,-11,-13,-14,0,14,13,11,9,7,4],[-3,-5,-7,-9,-10,-11,0,11,10,9,7,5,3],[-1,-3,-4,-6,-7,-8,0,8,7,6,4,3,1]],y:[[-1,-3,-4,-6,-7,-8,-9,-8,-7,-6,-4,-3,-1],[-3,-5,-7,-9,-10,-11,-12,-11,-10,-9,-7,-5,-3],[-4,-7,-9,-11,-13,-14,-15,-14,-13,-11,-9,-7,-4],[-6,-9,-11,-14,-16,-17,-18,-17,-16,-14,-11,-9,-6],[-7,-10,-13,-16,-18,-19,-20,-19,-18,-16,-13,-10,-7],[-8,-11,-14,-17,-19,-20,-21,-20,-19,-17,-14,-11,-8],[0,0,0,0,0,0,0,0,0,0,0,0,0],[8,11,14,17,19,20,21,20,19,17,14,11,8],[7,10,13,16,18,19,20,19,18,16,13,10,7],[6,9,11,14,16,17,18,17,16,14,11,9,6],[4,7,9,11,13,14,15,14,13,11,9,7,4],[3,5,7,9,10,11,12,11,10,9,7,5,3],[1,3,4,6,7,8,9,8,7,6,4,3,1]]};var wt;!function(t){t[t.UNSCALED=0]="UNSCALED",t[t.FACTOR_2=2]="FACTOR_2",t[t.FACTOR_4=4]="FACTOR_4",t[t.FACTOR_6=6]="FACTOR_6",t[t.FACTOR_8=8]="FACTOR_8",t[t.FACTOR_10=10]="FACTOR_10",t[t.FACTOR_12=12]="FACTOR_12",t[t.FACTOR_14=14]="FACTOR_14",t[t.FACTOR_16=16]="FACTOR_16"}(wt||(wt={}));class xt{constructor(t){this._grid=t,this._data=new Float64Array(3*this._grid.size)}get grid(){return this._grid}get data(){return this._data}precomputeVectors(t=wt.UNSCALED){switch(t){case wt.UNSCALED:this.precomputeUnscaledVectors();break;case wt.FACTOR_2:case wt.FACTOR_4:case wt.FACTOR_6:case wt.FACTOR_8:case wt.FACTOR_10:case wt.FACTOR_12:case wt.FACTOR_14:case wt.FACTOR_16:this.precomputeScaledVectors(t)}}setVector(t,e,i,r,n){const s=3*this._grid.getIndex(t,e);this._data[s]=i,this._data[s+1]=r,this._data[s+2]=n}precomputeUnscaledVectors(){for(let t=0;t<this._grid.height;t++)for(let e=0;e<this._grid.width;e++){const[i,r]=this._grid.pixelToMath(e,t),[n,s,o]=this.computeVector(i,r);this.setVector(e,t,n,s,o)}}precomputeScaledVectors(t){const e=new G({width:Math.ceil(this.grid.width/t),height:Math.ceil(this.grid.height/t),description:`${this.grid.resolution.description} scaled by factor ${t}}`},this.grid.range),i=new Float64Array(3*e.size);for(let t=0;t<e.height;t++)for(let r=0;r<e.width;r++){const[n,s]=e.pixelToMath(r,t),[o,a,h]=this.computeVector(n,s),c=3*e.getIndex(r,t);i[c]=o,i[c+1]=a,i[c+2]=h}this.scaleVectorField(e,i)}scaleVectorField(t,e){const i=(t.width-1)/(this.grid.width-1),r=(t.height-1)/(this.grid.height-1);for(let n=0;n<this.grid.height;n++){const s=n*r,o=Math.floor(s),a=Math.min(o+1,t.height-1),h=s-o;for(let r=0;r<this.grid.width;r++){const s=r*i,c=Math.floor(s),l=Math.min(c+1,t.width-1),d=s-c,u=3*t.getIndex(c,o),g=3*t.getIndex(c,a),p=3*t.getIndex(l,o),f=3*t.getIndex(l,a),_=[e[u],e[u+1]],v=[e[g],e[g+1]],y=[e[p],e[p+1]],m=[e[f],e[f+1]],w=this.bilinearInterpolation(d,h,_,v,y,m),x=Math.sqrt(w[0]*w[0]+w[1]*w[1]);this.setVector(r,n,w[0],w[1],x)}}}bilinearInterpolation(t,e,i,r,n,s){const o=[(1-t)*i[0]+t*n[0],(1-t)*i[1]+t*n[1]],a=[(1-t)*r[0]+t*s[0],(1-t)*r[1]+t*s[1]];return[(1-e)*o[0]+e*a[0],(1-e)*o[1]+e*a[1]]}}class bt extends xt{constructor(t,e,i){super(t),this._maxIterations=e;const r=new rt;this._mandelbrotData=r.calculateDistancesSync(this.grid,this._maxIterations,i),this.precomputeVectors()}computeVector(t,e){let i=0,r=0;const[n,s]=this.grid.mathToPixel(t,e);if(this._mandelbrotData[this.grid.getIndex(n,s)]==this._maxIterations)return[0,0,0];[i,r]=this.pixelGradient(n,s,mt);const o=Math.sqrt(i*i+r*r);return[i/o,r/o,o]}pixelGradient(t,e,i){let r=0,n=0;for(let s=-i.order;s<=i.order;s++)for(let o=-i.order;o<=i.order;o++){const a=this._mandelbrotData[this.grid.getIndex(t+s,e+o)];r+=a*i.x[s+i.order][o+i.order],n+=a*i.y[s+i.order][o+i.order]}return[r,n]}}const It={r:0,g:0,b:0},Rt={xMin:-3,xMax:1.8,yCenter:0};class St extends ht{constructor(t){super(t),this._effectiveMaxIterations=255,this.config=new e({gridRange:Rt,maxIterations:0,escapeValue:100,licLength:5,useNoiseAsSource:!0},"mandelbrotVectorConfig"),this.grid.updateRange(this.config.data.gridRange),this.calculate()}refresh(){this.calculate()}calculate(){return t=this,e=void 0,n=function*(){this._effectiveMaxIterations=ct(this.config.data.maxIterations,i(Rt),this.grid.xDiff),console.log(`#calculate - with max iterations ${this._effectiveMaxIterations}`),this.setProgress(0);const t=this.config.data.gridRange;this.grid.updateRange(t);const e=new pt(this.grid.resolution,t,2*this.config.data.licLength),r=new bt(e,this._effectiveMaxIterations,this.config.data.escapeValue),n=new yt(e),s={grid:e,image:this.config.data.useNoiseAsSource?n.createBernoulliNoiseSync(.3):this.createMandelbrotData(e,this._effectiveMaxIterations,this.config.data.escapeValue),field:r.data};this.updateImage(this.drawSourceImage(s));const o=new ft(s,this.grid).calculate(this.config.data.licLength);o.subscribe({next:t=>{this.setProgress(t.progress)}});const a=yield et(o);null!=a.data?(this.updateImage(this.drawImage(a.data)),this.setIdle()):console.error("#calculateAndDraw - calculation did not produce data")},new((r=void 0)||(r=Promise))(function(i,s){function o(t){try{h(n.next(t))}catch(t){s(t)}}function a(t){try{h(n.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(o,a)}h((n=n.apply(t,e||[])).next())});var t,e,r,n}createMandelbrotData(t,e,i){const r=new rt,n=new at([{color:nt,cycleLength:255},{color:st,cycleLength:255}]),s=r.calculateIterationsSync(t,e),o=new Float64Array(t.size);for(let e=0;e<t.height;e++)for(let i=0;i<t.width;i++){let r=s[t.getIndex(i,e)];r===this._effectiveMaxIterations&&(r=-1),o[t.getIndex(i,e)]=n.map(r).r/255}return o}drawSourceImage(t){const e=new Uint8ClampedArray(4*this.grid.size);for(let i=0;i<this.grid.height;i++)for(let r=0;r<this.grid.width;r++){const n=t.grid.getIndexForCenterArea(r,i),s=this.grid.getIndex(r,i);let o=Math.round(255*t.image[n]);const a=4*s;e[a]=o,e[a+1]=o,e[a+2]=o,e[a+3]=255}return e}drawImage(t){const e=new Uint8ClampedArray(4*this.grid.size);for(let i=0;i<this.grid.height;i++)for(let r=0;r<this.grid.width;r++){const n=this.grid.getIndex(r,i);let s=t[n];this.drawPixel(e,n,s==Number.MIN_SAFE_INTEGER?It:ot(s))}return e}drawPixel(t,e,i){const r=4*e;t[r]=i.r,t[r+1]=i.g,t[r+2]=i.b,t[r+3]=255}}var Mt=function(t){function e(e,i){return t.call(this)||this}return s(e,t),e.prototype.schedule=function(t,e){return void 0===e&&(e=0),this},e}(g),Ct={setInterval:function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var n=Ct.delegate;return(null==n?void 0:n.setInterval)?n.setInterval.apply(n,h([t,e],a(i))):setInterval.apply(void 0,h([t,e],a(i)))},clearInterval:function(t){var e=Ct.delegate;return((null==e?void 0:e.clearInterval)||clearInterval)(t)},delegate:void 0},Tt=function(t){function e(e,i){var r=t.call(this,e,i)||this;return r.scheduler=e,r.work=i,r.pending=!1,r}return s(e,t),e.prototype.schedule=function(t,e){var i;if(void 0===e&&(e=0),this.closed)return this;this.state=t;var r=this.id,n=this.scheduler;return null!=r&&(this.id=this.recycleAsyncId(n,r,e)),this.pending=!0,this.delay=e,this.id=null!==(i=this.id)&&void 0!==i?i:this.requestAsyncId(n,this.id,e),this},e.prototype.requestAsyncId=function(t,e,i){return void 0===i&&(i=0),Ct.setInterval(t.flush.bind(t,this),i)},e.prototype.recycleAsyncId=function(t,e,i){if(void 0===i&&(i=0),null!=i&&this.delay===i&&!1===this.pending)return e;null!=e&&Ct.clearInterval(e)},e.prototype.execute=function(t,e){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(t,e);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,e){var i,r=!1;try{this.work(t)}catch(t){r=!0,i=t||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),i},e.prototype.unsubscribe=function(){if(!this.closed){var e=this.id,i=this.scheduler,r=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,u(r,this),null!=e&&(this.id=this.recycleAsyncId(i,e,null)),this.delay=null,t.prototype.unsubscribe.call(this)}},e}(Mt),Bt={now:function(){return(Bt.delegate||Date).now()},delegate:void 0},At=function(){function t(e,i){void 0===i&&(i=t.now),this.schedulerActionCtor=e,this.now=i}return t.prototype.schedule=function(t,e,i){return void 0===e&&(e=0),new this.schedulerActionCtor(this,t).schedule(i,e)},t.now=Bt.now,t}(),Et=new(function(t){function e(e,i){void 0===i&&(i=At.now);var r=t.call(this,e,i)||this;return r.actions=[],r._active=!1,r}return s(e,t),e.prototype.flush=function(t){var e=this.actions;if(this._active)e.push(t);else{var i;this._active=!0;do{if(i=t.execute(t.state,t.delay))break}while(t=e.shift());if(this._active=!1,i){for(;t=e.shift();)t.unsubscribe();throw i}}},e}(At))(Tt);const Nt={xMin:0,xMax:1,yCenter:0};class Dt extends ht{constructor(t){super(t),this._noiseIndex=0,this.config=new e({gridRange:Nt},"noise"),this._generator=new yt(new pt(t.resolution,t.range,0)),this.create()}refresh(){}onDestroy(){var t;super.onDestroy(),null===(t=this._noiseIndexSubscription)||void 0===t||t.unsubscribe()}create(){const t=this.config.data.gridRange;this.grid.updateRange(t),this._noiseIndexSubscription=function(t,e,i){void 0===t&&(t=0),void 0===i&&(i=Et);var r,n=-1;return null!=e&&((r=e)&&c(r.schedule)?i=e:n=e),new U(function(e){var r=function(t){return t instanceof Date&&!isNaN(t)}(t)?+t-i.now():t;r<0&&(r=0);var s=0;return i.schedule(function(){e.closed||(e.next(s++),0<=n?this.schedule(void 0,n):e.complete())},r)})}(0,2e3).subscribe(()=>{this._noiseIndex++,this.createAndDraw(),this._noiseIndex>12&&(this._noiseIndex=0)})}createAndDraw(){return t=this,e=void 0,r=function*(){this.setProgress(0);const t=this.createNoise(this._noiseIndex);t.subscribe({next:t=>{this.setProgress(t.progress)}});const e=yield et(t);null!=e.data?(this._data=e.data,this.updateImage(this.createImage()),this.setIdle()):console.error("#calculate - calculation did not produce data")},new((i=void 0)||(i=Promise))(function(n,s){function o(t){try{h(r.next(t))}catch(t){s(t)}}function a(t){try{h(r.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,a)}h((r=r.apply(t,e||[])).next())});var t,e,i,r}createImage(){const t=new Uint8ClampedArray(4*this.grid.size);for(let e=0;e<this.grid.height;e++)for(let i=0;i<this.grid.width;i++){const r=this.grid.getIndex(i,e);let n=Math.round(255*this._data[r]);const s=4*this.grid.getIndex(i,e);t[s]=n,t[s+1]=n,t[s+2]=n,t[s+3]=255}return t}createNoise(t){switch(t){case 1:return console.log("#createNoise - Bernoulli Noise"),this._generator.createBernoulliNoise();case 2:return console.log("#createNoise - Isolated Black Noise"),this._generator.createBernoulliNoiseIsolated();case 3:return console.log("#createNoise - Isolated Big Black Noise"),this._generator.createBernoulliNoiseIsolatedBig();case 4:return console.log("#createNoise - Gaussian Noise"),this._generator.createGaussianNoise();case 5:return console.log("#createNoise - Biased Noise LOWER"),this._generator.createBiasedNoise(vt.LOWER);case 6:return console.log("#createNoise - Biased Noise UPPER"),this._generator.createBiasedNoise(vt.UPPER);case 7:return console.log("#createNoise - Biased Noise CENTER"),this._generator.createBiasedNoise(vt.CENTER);case 8:return console.log("#createNoise - Biased Noise BOUNDS"),this._generator.createBiasedNoise(vt.BOUNDS);case 9:return console.log("#createNoise - Biased Noise BOUNDS_BY_CUBIC"),this._generator.createBiasedNoise(vt.BOUNDS_BY_CUBIC);case 10:return console.log("#createNoise - Biased Noise BOUNDS_BY_QUINTIC"),this._generator.createBiasedNoise(vt.BOUNDS_BY_QUINTIC);case 11:return console.log("#createNoise - Biased Noise BOUNDS_BY_SEPTIC"),this._generator.createBiasedNoise(vt.BOUNDS_BY_SEPTIC);case 12:return console.log("#createNoise - Biased Noise BOUNDS_BY_TRIG"),this._generator.createBiasedNoise(vt.BOUNDS_BY_TRIG);default:return console.log("#createNoise - White Noise"),this._generator.createWhiteNoise()}}}const Ot=["MANDELBROT_ITERATIONS","MANDELBROT_DISTANCE","MANDELBROT_VECTOR","CHARGES","WEATHER","NOISE"],Lt=[{id:"MANDELBROT_ITERATIONS",short:"Mandelbrot Iterations",description:"Mandelbrot set visualization by number of iterations"},{id:"MANDELBROT_DISTANCE",short:"Mandelbrot Distance",description:"Mandelbrot set visualization by approximated distance to the border"},{id:"MANDELBROT_VECTOR",short:"Mandelbrot Vector Field",description:"Mandelbrot set visualization by distance approximation displayed as a vector field"},{id:"CHARGES",short:"Charge Field",description:"A vector field visualization for a charge field using an LIC algorithm"},{id:"WEATHER",short:"Weather patterns",description:"A vector field visualization for for weather patterns of pressure systems"},{id:"NOISE",short:"Noise types",description:"A set of different noise types"}];class Pt extends xt{constructor(t){super(t),this.charges=[{x:3,y:-1,magnitude:5},{x:5.5,y:-.5,magnitude:-10},{x:7,y:2,magnitude:3}],this.precomputeVectors()}computeVector(t,e){let i=0,r=0;for(let n=0;n<this.charges.length;n++){const s=t-this.charges[n].x,o=e-this.charges[n].y,a=Math.sqrt(s*s+o*o);i+=this.charges[n].magnitude*s/Math.pow(a,3),r+=this.charges[n].magnitude*o/Math.pow(a,3)}const n=Math.sqrt(i*i+r*r),s=Math.sqrt(i*i+r*r);return[i/s,r/s,n]}}const $t={xMin:0,xMax:10,yCenter:0};class Ut extends ht{constructor(t){super(t),this.config=new e({gridRange:$t,licLength:10},"chargesConfig"),this.calculate()}refresh(){this.calculate()}calculate(){return t=this,e=void 0,r=function*(){this.setProgress(0);const t=this.config.data.gridRange;this.grid.updateRange(t);const e=new pt(this.grid.resolution,t,2*this.config.data.licLength),i=new Pt(e),r={grid:e,image:new yt(e).createBiasedNoiseSync(vt.BOUNDS),field:i.data};this.updateImage(this.createSourceImage(r));const n=new ft(r,this.grid).calculate(this.config.data.licLength);n.subscribe({next:t=>{this.setProgress(t.progress)}});const s=yield et(n);null!=s.data?(this.updateImage(this.createImage(s.data)),this.setIdle()):console.error("#calculateAndDraw - calculation did not produce data")},new((i=void 0)||(i=Promise))(function(n,s){function o(t){try{h(r.next(t))}catch(t){s(t)}}function a(t){try{h(r.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,a)}h((r=r.apply(t,e||[])).next())});var t,e,i,r}createSourceImage(t){const e=new Uint8ClampedArray(4*this.grid.size);for(let i=0;i<this.grid.height;i++)for(let r=0;r<this.grid.width;r++){const n=t.grid.getIndexForCenterArea(r,i),s=this.grid.getIndex(r,i);let o=Math.round(255*t.image[n]);const a=4*s;e[a]=o,e[a+1]=o,e[a+2]=o,e[a+3]=255}return e}createImage(t){const e=new Uint8ClampedArray(4*this.grid.size);for(let i=0;i<this.grid.height;i++)for(let r=0;r<this.grid.width;r++){const n=this.grid.getIndex(r,i);let s=t[n];this.drawPixel(e,n,s==Number.MIN_SAFE_INTEGER?st:ot(s))}return e}drawPixel(t,e,i){const r=4*e;t[r]=i.r,t[r+1]=i.g,t[r+2]=i.b,t[r+3]=255}}const Ft=[0,0,0];class kt extends xt{constructor(t){super(t),this._pressureRegions=[],this._coriolisForce=1,[{x:0,y:-70,strength:988,spread:36,isLowPressure:!0},{x:95,y:60,strength:1036,spread:36,isLowPressure:!1},{x:135,y:-25,strength:1e3,spread:36,isLowPressure:!0},{x:145,y:45,strength:1028,spread:36,isLowPressure:!1},{x:170,y:52,strength:992,spread:36,isLowPressure:!0},{x:265,y:35,strength:1026,spread:36,isLowPressure:!1},{x:270,y:55,strength:996,spread:36,isLowPressure:!0},{x:280,y:-30,strength:1020,spread:36,isLowPressure:!1},{x:340,y:38,strength:1024,spread:36,isLowPressure:!1},{x:340,y:65,strength:980,spread:36,isLowPressure:!0}].forEach(t=>{const e=structuredClone(t);e.x-=360;const i=structuredClone(t);i.x+=360,this._pressureRegions.push(e),this._pressureRegions.push(t),this._pressureRegions.push(i)}),this._coriolisForce=1,this.precomputeVectors()}computeVector(t,e){const[i,r]=this.getGradient(t,e),n=this.getCoriolisFactor(e)*r+-.1*i,s=-this.getCoriolisFactor(e)*i+-.1*r,o=Math.sqrt(n*n+s*s);return o>0?[n,s,o]:Ft}getPressure(t,e){let i=0;for(const r of this._pressureRegions){const n=t-r.x,s=e-r.y,o=n*n+s*s,a=r.strength*Math.exp(-o/(2*r.spread*r.spread));i+=r.isLowPressure?-a:a}return i}getGradient(t,e){let i=0,r=0;for(const n of this._pressureRegions){const s=t-n.x,o=e-n.y,a=s*s+o*o,h=Math.exp(-a/(2*n.spread*n.spread)),c=n.strength*h/(n.spread*n.spread);i+=n.isLowPressure?-c*s:c*s,r+=n.isLowPressure?-c*o:c*o}return[i,r]}getCoriolisFactor(t){t>90&&(t=90),t<-90&&(t=-90);const e=t*Math.PI/180;return Math.sin(e)*this._coriolisForce}}const zt={xMin:-180,xMax:180,yCenter:0};class Vt extends ht{constructor(t){super(t),this.config=new e({gridRange:zt,licLength:20},"weatherConfig"),this.calculate()}refresh(){this.calculate()}calculate(){return t=this,e=void 0,r=function*(){this.setProgress(0);const t=this.config.data.gridRange;this.grid.updateRange(t);const e=new pt(this.grid.resolution,t,2*this.config.data.licLength),i=new kt(e),r={grid:e,image:new yt(e).createIsolatedBigBlackNoiseSync(.02),field:i.data};this.updateImage(this.createSourceImage(r));const n=new ft(r,this.grid).calculate(this.config.data.licLength,5,3.6);n.subscribe({next:t=>{this.setProgress(t.progress)}});const s=yield et(n);null!=s.data?(this.updateImage(this.createImage(s.data)),this.setIdle()):console.error("#calculateAndDraw - calculation did not produce data")},new((i=void 0)||(i=Promise))(function(n,s){function o(t){try{h(r.next(t))}catch(t){s(t)}}function a(t){try{h(r.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,a)}h((r=r.apply(t,e||[])).next())});var t,e,i,r}createSourceImage(t){const e=new Uint8ClampedArray(4*this.grid.size);for(let i=0;i<this.grid.height;i++)for(let r=0;r<this.grid.width;r++){const n=t.grid.getIndexForCenterArea(r,i),s=this.grid.getIndex(r,i);let o=Math.round(255*t.image[n]);const a=4*s;e[a]=o,e[a+1]=o,e[a+2]=o,e[a+3]=255}return e}createImage(t){const e=new Uint8ClampedArray(4*this.grid.size);for(let i=0;i<this.grid.height;i++)for(let r=0;r<this.grid.width;r++){const n=this.grid.getIndex(r,i);let s=t[n];this.drawPixel(e,n,s==Number.MIN_SAFE_INTEGER?st:ot(s))}return e}drawPixel(t,e,i){const r=4*e;t[r]=i.r,t[r+1]=i.g,t[r+2]=i.b,t[r+3]=255}}var Wt=function(t){function e(e,i,r,n,s,o){var a=t.call(this,e)||this;return a.onFinalize=s,a.shouldUnsubscribe=o,a._next=i?function(t){try{i(t)}catch(t){e.error(t)}}:t.prototype._next,a._error=n?function(t){try{n(t)}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._error,a._complete=r?function(){try{r()}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._complete,a}return s(e,t),e.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;t.prototype.unsubscribe.call(this),!i&&(null===(e=this.onFinalize)||void 0===e||e.call(this))}},e}(T);function Gt(t,e){return i=function(i,r){var n=0;i.subscribe(new Wt(r,function(i){return t.call(e,i,n++)&&r.next(i)},void 0,void 0,void 0))},function(t){if(function(t){return c(null==t?void 0:t.lift)}(t))return t.lift(function(t){try{return i(t,this)}catch(t){this.error(t)}});throw new TypeError("Unable to lift unknown Observable type")};var i}const Yt="invalid-rectangle",Ht="user-rectangle",Kt="norm-rectangle";var jt;!function(t){t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT"}(jt||(jt={}));const qt={pixel:"(left, top)",math:"(x, y)"};class Qt{constructor(t,e){this._displayableCoordinates$=new W(qt),this.displayableCoordinates$=this._displayableCoordinates$,this._selectedRange$=new z,this.selectedRange$=this._selectedRange$.pipe(Gt(t=>null!=t)),this._p1=null,this._p2=null,this._invalidRect=null,this._validRect=null,this._frozen=!1,this._overlay=t,this._grid=e,this.addSvgCss(),this._overlayRect=t.getBoundingClientRect(),this.addEventListeners()}selectRange(t){this._selectedRange$.next(t)}shiftRange(t){const e=this._grid.range,i=this._grid.xDiff;switch(t){case jt.UP:this._selectedRange$.next({xMin:e.xMin,xMax:e.xMax,yCenter:this._grid.pixelToMath(0,-.5*this._grid.height)[1]});break;case jt.DOWN:this._selectedRange$.next({xMin:e.xMin,xMax:e.xMax,yCenter:this._grid.pixelToMath(0,1.5*this._grid.height)[1]});break;case jt.LEFT:this._selectedRange$.next({xMin:e.xMin-i,xMax:e.xMax-i,yCenter:e.yCenter});break;case jt.RIGHT:this._selectedRange$.next({xMin:e.xMin+i,xMax:e.xMax+i,yCenter:e.yCenter})}}addSvgCss(){var t=window.document.styleSheets[0];t.insertRule(`#${Yt} { fill: none; stroke: #ff0000ff; stroke-width: 1; }`,t.cssRules.length),t.insertRule(`#${Ht} { fill: none; stroke: #90d5ffff; stroke-width: 1; }`,t.cssRules.length),t.insertRule(`#${Kt} { fill: #90d5ff88; stroke: none; }`,t.cssRules.length)}addEventListeners(){this._overlay.addEventListener("mousedown",t=>{this._frozen||this.onMouseDown(t)}),this._overlay.addEventListener("mousemove",t=>{this._frozen||this.onMouseMove(t)}),this._overlay.addEventListener("mouseup",t=>{this._frozen||this.onMouseUp(t)}),this._overlay.addEventListener("mouseleave",()=>{this._frozen||this.onMouseLeave()}),this._overlay.addEventListener("wheel",t=>{this._frozen||this.onMouseWheel(t)}),this._overlay.addEventListener("touchstart",t=>{this._frozen||this.onTouchStart(t)}),this._overlay.addEventListener("touchmove",t=>{this._frozen||this.onTouchMove(t)}),this._overlay.addEventListener("touchend",t=>{this._frozen||this.onTouchEnd(t)})}onTouchStart(t){this.processIncomingTouchEvents(t)&&t.preventDefault()}onTouchMove(t){this.processIncomingTouchEvents(t)&&t.preventDefault()}onTouchEnd(t){if(1==t.touches.length&&null!=this._validRect){const e=this.getMathCoordinatesFromRectangle(this._validRect.norm);this.emitSelection(e),t.preventDefault()}else if(null!=this._p1&&null==this._p2)return;this.resetInteraction()}processIncomingTouchEvents(t){return 1!=t.touches.length&&(2==t.touches.length?this.evaluateTouchRect(t)||this.resetInteraction():t.touches.length>2&&this.resetInteraction(),!0)}evaluateTouchRect(t){const e={x:t.touches[0].pageX,y:t.touches[0].pageY},i={x:t.touches[1].pageX,y:t.touches[1].pageY};return!this.pointIsOutside(e)&&!this.pointIsOutside(i)&&(e.x-=this._overlayRect.left,e.y-=this._overlayRect.top,i.x-=this._overlayRect.left,i.y-=this._overlayRect.top,this._p1=e,this._p2=i,this.evaluateRect(this._p1,this._p2),!0)}pointIsOutside(t){return t.x<this._overlayRect.left||t.x>this._overlayRect.right||t.y<this._overlayRect.top||t.y>this._overlayRect.bottom}onMouseDown(t){this._p1={x:t.offsetX,y:t.offsetY}}onMouseMove(t){this._p1?(this._p2={x:t.offsetX,y:t.offsetY},this.evaluateRect(this._p1,this._p2)):this.emitDisplayableCoordinates({x:t.offsetX,y:t.offsetY})}onMouseUp(t){if(null!=this._validRect){const t=this.getMathCoordinatesFromRectangle(this._validRect.norm);this.emitSelection(t)}else if(null!=this._p1&&null==this._p2)return void this.emitFromPosition(t.offsetX,t.offsetY,1);this.resetInteraction()}onMouseLeave(){this.resetInteraction()}resetInteraction(){this.resetAllSelections(),this.emitDisplayableCoordinates()}onMouseWheel(t){t.preventDefault(),this.removeInvalidRect(),this.removeValidRect();const e=t.deltaY<0?.25:4;this.emitFromPosition(t.offsetX,t.offsetY,e)}emitFromPosition(t,e,i){this.freeze();const r=this._grid.width*i,n=this._grid.height*i;if(this._p1={x:t-r/2,y:e-n/2},this._p2={x:t+r/2,y:e+n/2},this.createValidRect(this._p1,r,n),null!=this._validRect){const t=this.getMathCoordinatesFromRectangle(this._validRect.norm);setTimeout(()=>{this.unFreeze(),this.resetAllSelections(),this.emitSelection(t)},250)}}freeze(){this._frozen=!0}unFreeze(){this._frozen=!1}resetAllSelections(){this._p1=null,this._p2=null,this.removeInvalidRect(),this.removeValidRect()}removeInvalidRect(){null!=this._invalidRect&&(this._overlay.removeChild(this._invalidRect),this._invalidRect=null)}removeValidRect(){null!=this._validRect&&(this._overlay.removeChild(this._validRect.user),this._overlay.removeChild(this._validRect.norm),this._validRect=null)}evaluateRect(t,e){const i={x:Math.min(t.x,e.x),y:Math.min(t.y,e.y)},r=Math.abs(t.x-e.x),n=Math.abs(t.y-e.y);r<60?(this.removeValidRect(),null==this._invalidRect?this.createInvalidRect(i,r,n):this.updateInvalidRect(this._invalidRect,i,r,n),this.emitDisplayableCoordinates()):(this.removeInvalidRect(),null==this._validRect?this.createValidRect(i,r,n):this.updateValidRect(this._validRect,i,r,n),this.emitDisplayableCoordinates())}createInvalidRect(t,e,i){const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.id=Yt,r.setAttribute("x",t.x.toString()),r.setAttribute("y",t.y.toString()),r.setAttribute("width",e.toString()),r.setAttribute("height",i.toString()),this._invalidRect=r,this._overlay.appendChild(this._invalidRect)}updateInvalidRect(t,e,i,r){t.setAttribute("x",e.x.toString()),t.setAttribute("y",e.y.toString()),t.setAttribute("width",i.toString()),t.setAttribute("height",r.toString())}createValidRect(t,e,i){const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.id=Ht,r.setAttribute("x",t.x.toString()),r.setAttribute("y",t.y.toString()),r.setAttribute("width",e.toString()),r.setAttribute("height",i.toString());const[n,s,o]=this.evaluateNormRect(t,e,i),a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.id=Kt,a.setAttribute("x",n.x.toString()),a.setAttribute("y",n.y.toString()),a.setAttribute("width",s.toString()),a.setAttribute("height",o.toString()),this._validRect={user:r,norm:a},this._overlay.appendChild(this._validRect.user),this._overlay.appendChild(this._validRect.norm)}updateValidRect(t,e,i,r){t.user.setAttribute("x",e.x.toString()),t.user.setAttribute("y",e.y.toString()),t.user.setAttribute("width",i.toString()),t.user.setAttribute("height",r.toString());const[n,s,o]=this.evaluateNormRect(e,i,r);t.norm.setAttribute("x",n.x.toString()),t.norm.setAttribute("y",n.y.toString()),t.norm.setAttribute("width",s.toString()),t.norm.setAttribute("height",o.toString())}evaluateNormRect(t,e,i){const r=e/this._grid.ratio;return[{x:t.x,y:t.y+i/2-r/2},e,r]}emitSelection(t){this._selectedRange$.next({xMin:t.x1,xMax:t.x2,yCenter:t.y1+(t.y2-t.y1)/2})}emitDisplayableCoordinates(t=null){null!=this._validRect?this._displayableCoordinates$.next({pixel:this.rectangleCoordinatesToString(this.getPixelCoordinatesFromRectangle(this._validRect.norm)),math:this.rectangleCoordinatesToString(this.getMathCoordinatesFromRectangle(this._validRect.norm),!0)}):null!=this._invalidRect?this._displayableCoordinates$.next({pixel:this.rectangleCoordinatesToString(this.getPixelCoordinatesFromRectangle(this._invalidRect)),math:this.rectangleCoordinatesToString(this.getMathCoordinatesFromRectangle(this._invalidRect),!0)}):null!=t?this._displayableCoordinates$.next({pixel:`(${t.x}, ${t.y})`,math:this.getMathCoordinatesFromPoint(t)}):this._displayableCoordinates$.next(qt)}getPixelCoordinatesFromRectangle(t){const e=parseInt(t.getAttribute("x")||"0"),i=parseInt(t.getAttribute("y")||"0");return{x1:e,y1:i,x2:e+parseInt(t.getAttribute("width")||"0"),y2:i+parseInt(t.getAttribute("height")||"0")}}getMathCoordinatesFromRectangle(t){const e=parseInt(t.getAttribute("x")||"0"),i=parseInt(t.getAttribute("y")||"0"),r=parseInt(t.getAttribute("width")||"0"),n=parseInt(t.getAttribute("height")||"0"),[s,o]=this._grid.pixelToMath(e,i),[a,h]=this._grid.pixelToMath(e+r,i+n);return{x1:s,y1:o,x2:a,y2:h}}rectangleCoordinatesToString(t,e=!1){return e?`(${t.x1.toFixed(8)}, ${t.y1.toFixed(8)}) => (${t.x2.toFixed(8)}, ${t.y2.toFixed(8)})`:`(${t.x1}, ${t.y1}) => (${t.x2}, ${t.y2})`}getMathCoordinatesFromPoint(t){const[e,i]=this._grid.pixelToMath(t.x,t.y);return`(${e.toFixed(12)}, ${i.toFixed(12)})`}}class Xt{constructor(t,e){this._canvas=t,this._grid=e}draw(t){const e=this._canvas.getContext("2d");if(!e)throw new Error("Could not get 2D context");if(0==t.length)return;const i=new ImageData(t,this._grid.width,this._grid.height);e.putImageData(i,0,0)}}class Jt{constructor(t,e){this._subscription=null,this._canvas=new Xt(t,e)}draw(t){this._canvas.draw(t)}setPlane(t){var e;null===(e=this._subscription)||void 0===e||e.unsubscribe(),this._subscription=t.image$.subscribe(t=>{console.log(`#setPlane - plane.image subscription new Image of length ${t.length}`),this._canvas.draw(t)})}}class Zt{constructor(){this._widthParameter="width",this._heightParameter="height"}getResolution(){const t=j;if(!window.location.hash)return q(t);const e=window.location.hash.substring(1),i=new URLSearchParams(e),r=this.parseIntOrNull(i.get(this._widthParameter)),n=this.parseIntOrNull(i.get(this._heightParameter));return null!==r&&null!==n?[r,n]:q(t)}updateResolution(t,e){const i=`${this._widthParameter}=${encodeURIComponent(t)}&${this._heightParameter}=${encodeURIComponent(e)}`;window.history.replaceState(null,"",`#${i}`)}parseIntOrNull(t){if(!t)return null;const e=Number(t);return isNaN(e)?null:e}}new class{constructor(){this._plane=null,this._urlHandler=new Zt,this._headerArea=document.getElementById("header"),this._resolutionSelect=document.getElementById("resolutionSelect"),this._exportButton=document.getElementById("exportButton"),this._mainDiv=document.getElementById("main"),this._htmlCanvas=document.getElementById("canvas"),this._htmlSvg=document.getElementById("svgOverlay"),this._rangeArea=document.getElementById("rangeArea"),this._mathCoordsArea=document.getElementById("mathCoordsArea"),this._pixelCoordsArea=document.getElementById("pixelCoordsArea"),this._rangeInput=document.getElementById("rangeInput"),this._planeSelectArea=document.getElementById("planeSelectArea"),this._planeSelect=document.getElementById("planeSelect"),this._busySubscription=null,this._selectionSubscription=null,console.log("#constructor(Start) - YottaPXL - Version: 0.0.17"),function(t){const e="app-version",i=localStorage.getItem(e);i!==t&&(console.info(`#configVersionCheck - storedVersion=${i} does not match appVersion=${t}`),localStorage.clear(),caches.keys().then(t=>{t.forEach(t=>{caches.delete(t)})}),localStorage.setItem(e,t),window.location.reload())}("0.0.17"),this._config=new e({currentPlaneId:"MANDELBROT_ITERATIONS"},"mainConfig");const[t,i]=this._urlHandler.getResolution();let r=this.initializeResolution(t,i);r||(console.error("#ctor - initial resolution not found!"),r=j),this._grid=new H(r);let n=this.initializePlaneSelect();window.onload=()=>{this.init(n)}}init(t){null!=this._htmlCanvas&&null!=this._htmlSvg?(this.setHtmlCanvasSize(),this._interactionOverlay=new Qt(this._htmlSvg,this._grid),this._stage=new Jt(this._htmlCanvas,this._grid),this.switchPlane(t),this.subscribeToCoordinates(),this.subscribeToRange(),this.addResulutionsDropdownEventListener(),this.addPlaneDropdownEventListener(),this.addExportButtonClickListener(),this.addSetRangeButtonClickListener(),this.handlePhysicalKeyboardEvents()):console.error("Critical: HTML elements not found")}switchPlane(t){var e;switch(null===(e=this._plane)||void 0===e||e.onDestroy(),this._config.data.currentPlaneId=t,t){case"NOISE":this._plane=new Dt(this._grid);break;case"CHARGES":this._plane=new Ut(this._grid);break;case"WEATHER":this._plane=new Vt(this._grid);break;case"MANDELBROT_ITERATIONS":this._plane=new gt(this._grid);break;case"MANDELBROT_DISTANCE":this._plane=new dt(this._grid);break;case"MANDELBROT_VECTOR":this._plane=new St(this._grid)}this.subscribeToBusyState(),this.subscribeToSelection(),null!=this._plane?this._stage.setPlane(this._plane):console.error("Plane not initialized")}initializeResolution(t,e){this._resolutionSelect.innerHTML="";let i=null;for(const r of K){const n=document.createElement("option");n.label=`${r.description} - ${r.width}x${r.height}`,n.value=Q(r),r.width==t&&r.height==e&&(i=r,n.selected=!0),this._resolutionSelect.appendChild(n)}return i}initializePlaneSelect(){this._planeSelect.innerHTML="";let t=this._config.data.currentPlaneId;for(const e of Lt){const i=document.createElement("option");i.label=e.short,i.value=e.id,e.id==t&&(i.selected=!0),this._planeSelect.appendChild(i)}return t}setHtmlCanvasSize(){const t=this._grid.width,e=this._grid.height;this._htmlCanvas.width=t,this._htmlCanvas.height=e,this._htmlCanvas.setAttribute("width",`${t}px`),this._htmlCanvas.setAttribute("height",`${e}px`),this._htmlSvg.setAttribute("width",`${t}px`),this._htmlSvg.setAttribute("height",`${e}px`),this.setAreaWidth(this._headerArea,t),this.setAreaWidth(this._rangeArea,t),this.setAreaWidth(this._planeSelectArea,t),this._mainDiv.style.setProperty("visibility","visible")}setAreaWidth(t,e){null!=t&&(t.style.width=`${e+2}px`)}subscribeToCoordinates(){this._interactionOverlay.displayableCoordinates$.subscribe({next:t=>{null!=this._mathCoordsArea&&null!=this._pixelCoordsArea&&(this._mathCoordsArea.textContent=t.math,this._pixelCoordsArea.textContent=t.pixel)}})}subscribeToRange(){this._grid.range$.subscribe({next:t=>{this._rangeInput.value=r(t)}})}subscribeToSelection(){var t;null===(t=this._selectionSubscription)||void 0===t||t.unsubscribe(),this._selectionSubscription=this._interactionOverlay.selectedRange$.subscribe({next:t=>{var e;null===(e=this._plane)||void 0===e||e.updateGridRange(t)}})}subscribeToBusyState(){var t;null===(t=this._busySubscription)||void 0===t||t.unsubscribe(),null!=this._plane?this._busySubscription=this._plane.busy$.subscribe({next:t=>{var e,i,r,n;const s=document.getElementById("busyIndicator"),o=document.getElementById("progressBar"),a=document.getElementById("progress"),h=document.getElementById("resolutionSelect"),c=document.getElementById("exportButton");null!==t?(s.className="busyIndicator--busy",o.classList.remove("gone"),a.style.width=2.92*t+"px",h.classList.add("gone"),c.classList.add("gone"),this._htmlSvg.classList.add("gone"),null===(e=this._rangeArea)||void 0===e||e.classList.add("invisible"),null===(i=this._planeSelectArea)||void 0===i||i.classList.add("invisible")):(s.className="busyIndicator--idle",o.classList.add("gone"),a.style.width="0px",h.classList.remove("gone"),c.classList.remove("gone"),this._htmlSvg.classList.remove("gone"),null===(r=this._rangeArea)||void 0===r||r.classList.remove("invisible"),null===(n=this._planeSelectArea)||void 0===n||n.classList.remove("invisible"))}}):console.error("#subscribeToBusyState - unexpected _plane is null")}addResulutionsDropdownEventListener(){var t;null===(t=this._resolutionSelect)||void 0===t||t.addEventListener("change",t=>{const e=t.target.value,[i,r]=e.split("x").map(Number);console.log(`Selected resolution: ${i}x${r}`),this._urlHandler.updateResolution(i,r),window.location.reload()})}addPlaneDropdownEventListener(){var t;null===(t=this._planeSelect)||void 0===t||t.addEventListener("change",t=>{const e=t.target.value;console.log(`Selected plane: ${e}`),Ot.includes(e)?this.switchPlane(e):console.warn(`Invalid plane ID: ${e}`)})}addExportButtonClickListener(){var t;null===(t=this._exportButton)||void 0===t||t.addEventListener("click",t=>{const e=r(this._grid.range);let i=prompt("Enter a filename",`YottaPXL_Range_${e}`);if(!i)return;i+=".png";const n=this._htmlCanvas.toDataURL("image/png"),s=document.createElement("a");s.download=i,s.href=n,s.click(),setTimeout(()=>{s.remove()},100)})}addSetRangeButtonClickListener(){const t=document.getElementById("setRangeButton");null==t||t.addEventListener("click",t=>{const e=function(t){const e=t.split("_");if(3!=e.length)return console.warn(`#gridRangeFromString - invalid input (parts.length != 3) instead ${e.length}`,t),null;const i=parseFloat(e[0]),r=parseFloat(e[1]),n=parseFloat(e[2]);return i>=r?(console.warn(`#gridRangeFromString - invalid input (xMin >= xMax) instead xMin=${i}, xMax=${r}`,t),null):{xMin:i,xMax:r,yCenter:n}}(this._rangeInput.value);null!==e&&this._interactionOverlay.selectRange(e)});const e=document.getElementById("resetRangeButton");null==e||e.addEventListener("click",t=>{null!=this._plane?this._plane.updateGridRange(null):console.error("#subscribeToBusyState - unexpected _plane is null")})}handlePhysicalKeyboardEvents(){document.addEventListener("keydown",t=>{const e=document.activeElement;(null===e||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName)&&this.handleKeyPress(t.key)},!1)}handleKeyPress(t){var e;switch(t){case"ArrowUp":this._interactionOverlay.shiftRange(jt.UP);break;case"ArrowDown":this._interactionOverlay.shiftRange(jt.DOWN);break;case"ArrowLeft":this._interactionOverlay.shiftRange(jt.LEFT);break;case"ArrowRight":this._interactionOverlay.shiftRange(jt.RIGHT);break;case"Escape":null===(e=this._plane)||void 0===e||e.updateGridRange(null)}}}})();