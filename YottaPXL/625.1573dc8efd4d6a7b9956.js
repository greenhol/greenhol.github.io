(()=>{"use strict";function t(t){return t.xMax-t.xMin}class i{static copy(t){return new i(t.resolution,t.range)}constructor(t,i){this._resolution=t,this._width=t.width,this._height=t.height,this.setRange(i),console.log(`Grid (${this._width} x ${this._height}) created for resolution: ${t.description}`)}updateRange(t){this.setRange(t),console.log(`Grid (${this._width} x ${this._height}) range set to: ${t.xMin} -> ${t.xMax} and yCenter: ${t.yCenter}`)}getIndex(t,i){return i*this._width+t}pixelToMath(t,i){return[this._xMin+t/this.width*this._xDiff,this._yMax-i/this.height*this._yDiff]}mathToPixel(t,i){return[Math.round((t-this._xMin)*this.width/this._xDiff),Math.round((this._yMax-i)*this.height/this._yDiff)]}get resolution(){return this._resolution}get width(){return this._width}get height(){return this._height}get size(){return this._width*this._height}get ratio(){return this._width/this._height}get range(){return this._range}get xDiff(){return this._xDiff}get blueprint(){return{resolution:{width:this._width,height:this.height,description:`${this._resolution.description} (Copy)`},range:this._range}}toString(){return`width: ${this.width}, height:${this.height} -> size ${this.size}`}setRange(i){this._range=i,this._yDiff=t(i)/this.ratio,this._xMin=i.xMin,this._xMax=i.xMax,this._xDiff=t(i),this._yMin=i.yCenter-this._yDiff/2,this._yMax=i.yCenter+this._yDiff/2}}class e extends i{static resolutionWithMargin(t,i){return{width:t.width+2*i,height:t.height+2*i,description:`${t.description} + buffer:${i}`}}static copyWithMargin(t){return new e(t.baseResolution,t.baseRange,t.margin)}constructor(i,n,r){const s=e.resolutionWithMargin(i,r).width/i.width,h=t(n),a=n.xMin+t(n)/2;super(e.resolutionWithMargin(i,r),{xMin:a-h/2*s,xMax:a+h/2*s,yCenter:n.yCenter}),this._baseResolution=i,this._baseRange=n,this._margin=r}getIndexForCenterArea(t,i){return super.getIndex(t+this._margin,i+this._margin)}get margin(){return this._margin}get withMarginBlueprint(){return{baseResolution:{width:this._baseResolution.width,height:this._baseResolution.height,description:`${this._baseResolution.description} (Copy)`},baseRange:this._baseRange,margin:this._margin}}}var n,r;!function(t){t.START="START"}(n||(n={})),function(t){t.UPDATE="UPDATE",t.RESULT="RESULT"}(r||(r={}));class s{constructor(t,i){if(i.length!==3*t.size)throw Error(`grid (size=${t.size}) and data (data.length=${i.length}) do not match. (data.length !== grid.size * 3)`);this._grid=t,this._data=i}getVector(t,i){const e=3*this._grid.getIndex(t,i);return[this._data[e],this._data[e+1]]}getMagnitude(t,i){return this._data[3*this._grid.getIndex(t,i)+2]}}function h(t,i,e,n,r,s){let h=a(t,i,e,1,n,r,s);return h+=a(t,i,e,-1,n,r,s),h/=2*e,h>1&&(h=1),h}function a(t,i,e,n,r,s,h){let a=e,[g,d]=h.getVector(t+r.margin,i+r.margin);if(0==g&&0==d)return Number.MIN_SAFE_INTEGER;g*=n,d*=n;let[u,c]=[g,d],f=o(.5,.5,g,d),_=f.distance<a?f.distance:a,l=s[r.getIndexForCenterArea(t,i)]*_;for(a=e-f.distance;a>0;)i+=f.rowDiff,t+=f.colDiff,[g,d]=h.getVector(t+r.margin,i+r.margin),Number.isNaN(g)||Number.isNaN(d)||0==g&&0==d?[g,d]=[u,c]:[u,c]=[g,d],g*=n,d*=n,f=o(f.x,f.y,g,d),_=f.distance<a?f.distance:a,l+=s[r.getIndexForCenterArea(t,i)]*_,a-=f.distance;return l}function o(t,i,e,n){let r,s=[];s.push((1-i)/n),s.push(-i/n),s.push(-t/e),s.push((1-t)/e),s.forEach((t,i)=>{t<=0&&(s[i]=1/0)});const h=s.indexOf(Math.min(...s)),a=Math.sqrt(Math.pow(s[h]*e,2)+Math.pow(s[h]*n,2))/Math.SQRT2;switch(h){case 0:return r=e*s[h]+t,{rowDiff:-1,colDiff:0,x:r,y:.01,distance:a};case 1:return r=e*s[h]+t,{rowDiff:1,colDiff:0,x:r,y:.99,distance:a};case 2:return r=n*s[h]+i,{rowDiff:0,colDiff:-1,x:.99,y:r,distance:a};case 3:return r=n*s[h]+i,{rowDiff:0,colDiff:1,x:.01,y:r,distance:a};default:return{rowDiff:0,colDiff:0,x:.5,y:.5,distance:a}}}self.onmessage=t=>{const{type:a,data:o}=t.data;if(a===n.START){const t=function(t){const n=i.copy(t.targetGridBlueprint),a=e.copyWithMargin(t.sourceGridBlueprint),o=t.image,g=new s(a,t.field);let d=Date.now();const u=new Float64Array(n.size);let c=0;for(let i=0;i<n.height;i++){for(let e=0;e<n.width;e++){let r=t.maxLength;const s=g.getMagnitude(e+a.margin,i+a.margin);t.strength>0&&(r=Math.min(t.maxLength,s*t.strength),r=Math.max(t.minLength,r)),u[n.getIndex(e,i)]=0==s?Number.MIN_SAFE_INTEGER:h(e,i,r,a,o,g)}if(c+=n.width,c>25e3){const t=Math.round(i*n.width*100/n.size);self.postMessage({type:r.UPDATE,progress:t}),c=0}}return console.info("calculation done in "+(Date.now()-d)/1e3+"s"),u}(o);self.postMessage({type:r.RESULT,result:t},[t.buffer])}}})();